await sb.from('logs_sistema').insert([{
                    accion: 'setup_completado',
                    usuario: wizardData.superAdmin.username,
                    detalles: `Sistema configurado. Instituci√≥n: ${wizardData.institucion.nombre}`,
                    institucion_id: inst.id
                }]);
                
                hideLoading();
                showNotification('¬°Sistema configurado exitosamente!', 'success');
                
                // Guardar flag de setup completado
                localStorage.setItem('renam_setup_complete', 'true');
                
                // Mostrar credenciales
                showModal('üéâ ¬°Setup Completado!', `
                    <div class="space-y-4">
                        <div class="bg-green-50 p-4 rounded-xl border-2 border-green-200">
                            <p class="font-bold text-green-900 mb-2">‚úÖ Sistema Configurado</p>
                            <p class="text-sm text-green-700">El sistema est√° listo para usar</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
                            <p class="font-bold text-purple-900 mb-2">üîê Credenciales Super Admin</p>
                            <p class="text-sm text-purple-700 font-mono">Usuario: ${wizardData.superAdmin.username}</p>
                            <p class="text-sm text-purple-700 font-mono">Contrase√±a: ${wizardData.superAdmin.password}</p>
                            <p class="text-xs text-purple-600 mt-2">‚ö†Ô∏è Guarda estas credenciales en un lugar seguro</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                            <p class="font-bold text-blue-900 mb-2">üè¢ Instituci√≥n</p>
                            <p class="text-sm text-blue-700">${wizardData.institucion.nombre}</p>
                            <p class="text-sm text-blue-700 font-mono">C√≥digo: ${wizardData.codigo}</p>
                        </div>
                    </div>
                `, [{
                    text: 'üöÄ Ir al Login',
                    class: 'bg-green-600 text-white',
                    action: 'irAlLogin()'
                }]);
                
            } catch (error) {
                hideLoading();
                showNotification(error.message, 'error');
                console.error('Error en setup:', error);
            }
        }

        function irAlLogin() {
            closeModal();
            document.getElementById('onboarding-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            loadInstituciones();
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // Validaci√≥n de fuerza de contrase√±a en tiempo real
        document.addEventListener('DOMContentLoaded', () => {
            const pwdInput = document.getElementById('wizard-super-password');
            if (pwdInput) {
                pwdInput.oninput = (e) => {
                    const strength = checkPasswordStrength(e.target.value);
                    const display = document.getElementById('password-strength-1');
                    display.innerHTML = `<span class="${strength.class}">Seguridad: ${strength.text}</span>`;
                };
            }
        });

        // SISTEMA DE AUTENTICACI√ìN
        async function checkSetupStatus() {
            const setupComplete = localStorage.getItem('renam_setup_complete');
            
            if (setupComplete) {
                return true;
            }
            
            // Verificar si ya hay usuarios en la BD
            const { data: usuarios, error } = await sb.from('usuarios').select('*').limit(1);
            
            if (error) {
                // Si hay error es porque la tabla no existe, mostrar instrucciones SQL
                showModal('‚ö†Ô∏è Configuraci√≥n de Base de Datos', `
                    <div class="bg-yellow-50 p-4 rounded-lg mb-4">
                        <p class="font-bold text-yellow-900 mb-2">Las tablas no existen en Supabase</p>
                        <p class="text-sm text-yellow-800">Ejecuta el siguiente SQL en tu base de datos:</p>
                    </div>
                    <div class="bg-slate-900 text-green-400 p-4 rounded-lg text-xs font-mono overflow-auto max-h-96">
                        <pre>-- SCRIPT DE CONFIGURACI√ìN RENAM v4.0

-- 1. Tabla instituciones
CREATE TABLE IF NOT EXISTS instituciones (
  id BIGSERIAL PRIMARY KEY,
  nombre TEXT NOT NULL,
  codigo TEXT UNIQUE NOT NULL,
  email TEXT,
  limite_alumnos INTEGER DEFAULT 1000,
  limite_usuarios INTEGER DEFAULT 50,
  estado TEXT DEFAULT 'activo' CHECK (estado IN ('activo', 'suspendido')),
  created_at TIMESTAMP DEFAULT NOW()
);

-- 2. Tabla usuarios
CREATE TABLE IF NOT EXISTS usuarios (
  id BIGSERIAL PRIMARY KEY,
  username TEXT UNIQUE NOT NULL,
  password TEXT NOT NULL,
  nombre_completo TEXT,
  email TEXT,
  rol TEXT NOT NULL CHECK (rol IN ('super_admin', 'admin', 'editor', 'visor')),
  institucion_id BIGINT REFERENCES instituciones(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT NOW()
);

-- 3. Actualizar tabla alumnos
ALTER TABLE alumnos ADD COLUMN IF NOT EXISTS institucion_id BIGINT REFERENCES instituciones(id) ON DELETE CASCADE;

-- 4. Actualizar tabla cursos
ALTER TABLE cursos ADD COLUMN IF NOT EXISTS institucion_id BIGINT REFERENCES instituciones(id) ON DELETE CASCADE;

-- 5. Actualizar tabla certificaciones
ALTER TABLE certificaciones ADD COLUMN IF NOT EXISTS institucion_id BIGINT REFERENCES instituciones(id) ON DELETE CASCADE;

-- 6. Tabla historial_emisiones
CREATE TABLE IF NOT EXISTS historial_emisiones (
  id BIGSERIAL PRIMARY KEY,
  alumno_dni TEXT NOT NULL,
  usuario_emisor TEXT NOT NULL,
  institucion_id BIGINT REFERENCES instituciones(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT NOW()
);

-- 7. Tabla logs_sistema (NUEVA)
CREATE TABLE IF NOT EXISTS logs_sistema (
  id BIGSERIAL PRIMARY KEY,
  accion TEXT NOT NULL,
  usuario TEXT NOT NULL,
  detalles TEXT,
  institucion_id BIGINT REFERENCES instituciones(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- 8. Habilitar RLS
ALTER TABLE instituciones ENABLE ROW LEVEL SECURITY;
ALTER TABLE usuarios ENABLE ROW LEVEL SECURITY;
ALTER TABLE historial_emisiones ENABLE ROW LEVEL SECURITY;
ALTER TABLE logs_sistema ENABLE ROW LEVEL SECURITY;

-- 9. Pol√≠ticas de acceso p√∫blico (temporal)
CREATE POLICY IF NOT EXISTS "Public access" ON instituciones FOR ALL USING (true);
CREATE POLICY IF NOT EXISTS "Public access" ON usuarios FOR ALL USING (true);
CREATE POLICY IF NOT EXISTS "Public access" ON historial_emisiones FOR ALL USING (true);
CREATE POLICY IF NOT EXISTS "Public access" ON logs_sistema FOR ALL USING (true);</pre>
                    </div>
                    <div class="mt-4 bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm font-bold text-blue-900 mb-2">üìã Pasos:</p>
                        <ol class="text-sm text-blue-800 list-decimal list-inside space-y-1">
                            <li>Ve a Supabase Dashboard ‚Üí SQL Editor</li>
                            <li>Copia y pega el c√≥digo SQL</li>
                            <li>Clic en "Run"</li>
                            <li>Recarga esta p√°gina</li>
                        </ol>
                    </div>
                `, []);
                return false;
            }
            
            if (!usuarios || usuarios.length === 0) {
                // No hay usuarios, iniciar onboarding
                return false;
            }
            
            // Ya hay usuarios, setup ya fue hecho
            localStorage.setItem('renam_setup_complete', 'true');
            return true;
        }

        async function loadInstituciones() {
            try {
                const { data, error } = await sb.from('instituciones').select('*').order('nombre');
                const select = document.getElementById('login-institucion');
                const selectSA = document.getElementById('sa-user-institucion');
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const options = data.map(i => `<option value="${i.id}">${i.nombre}</option>`).join('');
                    select.innerHTML = options;
                    if (selectSA) selectSA.innerHTML = '<option value="">Seleccionar...</option>' + options;
                } else {
                    select.innerHTML = '<option value="">No hay instituciones</option>';
                }
            } catch (error) {
                console.error('Error cargando instituciones:', error);
                document.getElementById('login-institucion').innerHTML = '<option value="">Error al cargar</option>';
            }
        }

        // LOGIN
        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('login-btn');
            btn.disabled = true;
            btn.textContent = 'Verificando...';

            try {
                const username = sanitizeInput(document.getElementById('login-username').value);
                const password = document.getElementById('login-password').value;
                const institucionId = document.getElementById('login-institucion').value;

                const { data: user, error } = await sb
                    .from('usuarios')
                    .select('*, instituciones(nombre)')
                    .eq('username', username)
                    .eq('password', password)
                    .eq('institucion_id', institucionId)
                    .single();

                if (error || !user) throw new Error('Credenciales inv√°lidas');

                currentSession = {
                    user: user.username,
                    rol: user.rol,
                    institucion_id: user.institucion_id,
                    institucion_nombre: user.instituciones.nombre,
                    user_id: user.id,
                    nombre_completo: user.nombre_completo
                };

                localStorage.setItem('renam_session', JSON.stringify(currentSession));
                
                // Log de inicio de sesi√≥n
                await sb.from('logs_sistema').insert([{
                    accion: 'login',
                    usuario: user.username,
                    detalles: 'Inicio de sesi√≥n exitoso',
                    institucion_id: user.institucion_id
                }]);

                if (user.rol === 'super_admin') {
                    await setupSuperAdminMode();
                } else {
                    await setupAdminMode();
                }
                
                showNotification('¬°Bienvenido!', 'success');

            } catch (err) {
                showNotification(err.message, 'error');
                btn.disabled = false;
                btn.textContent = 'üîê Iniciar Sesi√≥n';
            }
        };

        function logout() {
            if (!confirm('¬øCerrar sesi√≥n?')) return;
            
            // Log de cierre de sesi√≥n
            if (currentSession) {
                sb.from('logs_sistema').insert([{
                    accion: 'logout',
                    usuario: currentSession.user,
                    detalles: 'Cierre de sesi√≥n',
                    institucion_id: currentSession.institucion_id
                }]);
            }
            
            localStorage.removeItem('renam_session');
            currentSession = null;
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('superadmin-panel').classList.add('hidden');
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            showNotification('Sesi√≥n cerrada', 'info');
        }

        // SUPER ADMIN MODE
        async function setupSuperAdminMode() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('superadmin-panel').classList.remove('hidden');
            
            document.getElementById('superadmin-user-info').textContent = 
                `${currentSession.nombre_completo || currentSession.user} | ${currentSession.institucion_nombre}`;
            
            await loadDashboardStats();
            await loadInstitucionesTable();
        }

        function switchSuperAdminTab(tab) {
            const tabs = ['dashboard', 'instituciones', 'usuarios', 'logs', 'config'];
            tabs.forEach(t => {
                const content = document.getElementById('sa-content-' + t);
                const btn = document.getElementById('sa-tab-' + t);
                if (content) content.classList.toggle('hidden', t !== tab);
                if (btn) btn.classList.toggle('tab-active', t === tab);
            });
            
            if (tab === 'instituciones') loadInstitucionesTable();
            if (tab === 'usuarios') loadUsuariosTable();
            if (tab === 'logs') loadLogsTable();
            if (tab === 'config') loadSystemConfig();
        }

        async function loadDashboardStats() {
            try {
                const { data: instituciones } = await sb.from('instituciones').select('*', { count: 'exact', head: true });
                const { data: usuarios } = await sb.from('usuarios').select('*', { count: 'exact', head: true });
                const { data: credenciales } = await sb.from('historial_emisiones').select('*', { count: 'exact', head: true });
                
                document.getElementById('stat-instituciones').textContent = instituciones?.length || 0;
                document.getElementById('stat-usuarios').textContent = usuarios?.length || 0;
                document.getElementById('stat-credenciales').textContent = credenciales?.length || 0;
                
                // Actividad reciente
                const { data: logs } = await sb.from('logs_sistema')
                    .select('*, instituciones(nombre)')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                const activityDiv = document.getElementById('recent-activity');
                if (logs && logs.length > 0) {
                    activityDiv.innerHTML = logs.map(log => `
                        <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                            <div>
                                <p class="text-sm font-bold text-slate-800">${log.accion}</p>
                                <p class="text-xs text-slate-500">${log.usuario} | ${log.instituciones?.nombre || 'N/A'}</p>
                            </div>
                            <span class="text-xs text-slate-400">${new Date(log.created_at).toLocaleString('es-AR')}</span>
                        </div>
                    `).join('');
                } else {
                    activityDiv.innerHTML = '<p class="text-sm text-slate-400 text-center py-4">Sin actividad reciente</p>';
                }
                
                // Alertas (instituciones cerca del l√≠mite)
                const { data: instData } = await sb.from('instituciones').select('*, alumnos(count)');
                const alertsDiv = document.getElementById('alerts-list');
                const alerts = [];
                
                if (instData) {
                    instData.forEach(inst => {
                        const count = inst.alumnos?.length || 0;
                        const limit = inst.limite_alumnos || 1000;
                        const percentage = (count / limit) * 100;
                        
                        if (percentage >= 80) {
                            alerts.push(`
                                <div class="flex items-center justify-between p-3 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                                    <div>
                                        <p class="text-sm font-bold text-orange-800">${inst.nombre}</p>
                                        <p class="text-xs text-orange-600">Alumnos: ${count}/${limit} (${percentage.toFixed(0)}%)</p>
                                    </div>
                                    <span class="text-2xl">‚ö†Ô∏è</span>
                                </div>
                            `);
                        }
                    });
                }
                
                if (alerts.length > 0) {
                    alertsDiv.innerHTML = alerts.join('');
                } else {
                    alertsDiv.innerHTML = '<p class="text-sm text-slate-400 text-center py-4">‚úÖ Sin alertas</p>';
                }
                
            } catch (error) {
                console.error('Error cargando dashboard:', error);
            }
        }

        // GESTI√ìN DE INSTITUCIONES
        async function loadInstitucionesTable() {
            showLoading('Cargando instituciones...');
            
            try {
                const { data } = await sb.from('instituciones')
                    .select('*, usuarios(count), alumnos(count)')
                    .order('created_at', { ascending: false });
                
                const table = document.getElementById('instituciones-table');
                if (data && data.length > 0) {
                    table.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>C√≥digo</th>
                                    <th>Email</th>
                                    <th>Usuarios</th>
                                    <th>Alumnos</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(inst => {
                                    const usuariosCount = inst.usuarios?.[0]?.count || 0;
                                    const alumnosCount = inst.alumnos?.[0]?.count || 0;
                                    return `
                                        <tr>
                                            <td class="font-bold">${inst.nombre}</td>
                                            <td><code class="text-xs bg-slate-100 px-2 py-1 rounded">${inst.codigo}</code></td>
                                            <td class="text-xs">${inst.email || 'N/A'}</td>
                                            <td>${usuariosCount}/${inst.limite_usuarios || 50}</td>
                                            <td>${alumnosCount}/${inst.limite_alumnos || 1000}</td>
                                            <td><span class="badge badge-${inst.estado}">${inst.estado.toUpperCase()}</span></td>
                                            <td>
                                                <button onclick="editarInstitucion(${inst.id})" class="action-btn btn-edit">‚úèÔ∏è</button>
                                                <button onclick="suspenderInstitucion(${inst.id}, '${inst.estado}')" class="action-btn btn-suspend">${inst.estado === 'activo' ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}</button>
                                                <button onclick="verDetallesInstitucion(${inst.id})" class="action-btn btn-view">üëÅÔ∏è</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    table.innerHTML = '<p class="text-center text-gray-400 p-8">No hay instituciones registradas</p>';
                }
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error cargando instituciones', 'error');
            } finally {
                hideLoading();
            }
            
            // B√∫squeda
            document.getElementById('search-instituciones').oninput = (e) => {
                const search = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#instituciones-table tbody tr');
                rows.forEach(row => {
                    const match = row.textContent.toLowerCase().includes(search);
                    row.style.display = match ? '' : 'none';
                });
            };
        }

        async function crearInstitucion() {
            const nombre = sanitizeInput(document.getElementById('sa-inst-nombre').value);
            const email = sanitizeInput(document.getElementById('sa-inst-email').value);
            const limiteAlumnos = parseInt(document.getElementById('sa-inst-limite-alumnos').value) || 1000;
            const limiteUsuarios = parseInt(document.getElementById('sa-inst-limite-usuarios').value) || 50;
            
            if (!nombre || !email) {
                return showNotification('Completa todos los campos obligatorios', 'error');
            }
            
            showLoading('Creando instituci√≥n...');
            
            try {
                const codigo = generateInstitucionCode();
                
                const { error } = await sb.from('instituciones').insert([{
                    nombre,
                    codigo,
                    email,
                    limite_alumnos: limiteAlumnos,
                    limite_usuarios: limiteUsuarios,
                    estado: 'activo'
                }]);
                
                if (error) throw error;
                
                // Log
                await sb.from('logs_sistema').insert([{
                    accion: 'crear_institucion',
                    usuario: currentSession.user,
                    detalles: `Instituci√≥n creada: ${nombre} (${codigo})`,
                    institucion_id: currentSession.institucion_id
                }]);
                
                showNotification('‚úÖ Instituci√≥n creada exitosamente', 'success');
                limpiarFormInstitucion();
                await loadInstitucionesTable();
                await loadInstituciones();
                
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function limpiarFormInstitucion() {
            document.getElementById('sa-inst-nombre').value = '';
            document.getElementById('sa-inst-email').value = '';
            document.getElementById('sa-inst-limite-alumnos').value = '1000';
            document.getElementById('sa-inst-limite-usuarios').value = '50';
        }

        async function suspenderInstitucion(id, estadoActual) {
            const nuevoEstado = estadoActual === 'activo' ? 'suspendido' : 'activo';
            const confirmar = confirm(`¬ø${nuevoEstado === 'suspendido' ? 'Suspender' : 'Reactivar'} esta instituci√≥n?`);
            
            if (!confirmar) return;
            
            try {
                const { error } = await sb.from('instituciones').update({ estado: nuevoEstado }).eq('id', id);
                if (error) throw error;
                
                // Log
                await sb.from('logs_sistema').insert([{
                    accion: nuevoEstado === 'suspendido' ? 'suspender_institucion' : 'reactivar_institucion',
                    usuario: currentSession.user,
                    detalles: `Instituci√≥n ID: ${id}`,
                    institucion_id: currentSession.institucion_id
                }]);
                
                showNotification(`‚úÖ Instituci√≥n ${nuevoEstado === 'suspendido' ? 'suspendida' : 'reactivada'}`, 'success');
                await loadInstitucionesTable();
                
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // GESTI√ìN DE USUARIOS
        function generarPassword() {
            const password = generateSecurePassword(14);
            document.getElementById('sa-user-password').value = password;
            
            const strength = checkPasswordStrength(password);
            const display = document.getElementById('password-strength-display');
            if (display) {
                display.innerHTML = `Seguridad: <span class="${strength.class}">${strength.text}</span>`;
            }
        }

        // Auto-generar username cuando se ingresa nombre
        document.addEventListener('DOMContentLoaded', () => {
            const nombreInput = document.getElementById('sa-user-nombre');
            if (nombreInput) {
                nombreInput.oninput = (e) => {
                    const username = generateUsername(e.target.value);
                    document.getElementById('sa-user-username').value = username;
                };
            }
        });

        async function crearUsuario() {
            const institucionId = document.getElementById('sa-user-institucion').value;
            const rol = document.getElementById('sa-user-rol').value;
            const nombre = sanitizeInput(document.getElementById('sa-user-nombre').value);
            const email = sanitizeInput(document.getElementById('sa-user-email').value);
            let username = document.getElementById('sa-user-username').value;
            let password = document.getElementById('sa-user-password').value;
            
            if (!institucionId || !nombre || !email) {
                return showNotification('Completa todos los campos', 'error');
            }
            
            // Generar credenciales si est√°n vac√≠as
            if (!username) username = generateUsername(nombre);
            if (!password) password = generateSecurePassword(14);
            
            showLoading('Creando usuario...');
            
            try {
                const { error } = await sb.from('usuarios').insert([{
                    username,
                    password,
                    nombre_completo: nombre,
                    email,
                    rol,
                    institucion_id: institucionId
                }]);
                
                if (error) throw error;
                
                // Log
                await sb.from('logs_sistema').insert([{
                    accion: 'crear_usuario',
                    usuario: currentSession.user,
                    detalles: `Usuario creado: ${username} (${rol})`,
                    institucion_id: currentSession.institucion_id
                }]);
                
                // Mostrar credenciales generadas
                document.getElementById('generated-username-display').textContent = username;
                document.getElementById('generated-password-display').textContent = password;
                document.getElementById('password-display-area').classList.remove('hidden');
                document.getElementById('copy-credentials-btn').classList.remove('hidden');
                
                const strength = checkPasswordStrength(password);
                document.getElementById('password-strength-display').innerHTML = 
                    `Seguridad: <span class="${strength.class}">${strength.text}</span>`;
                
                showNotification('‚úÖ Usuario creado exitosamente', 'success');
                await loadUsuariosTable();
                
            } catch (error) {
                if (error.message.includes('duplicate')) {
                    showNotification('El usuario ya existe. Prueba con otro nombre', 'error');
                } else {
                    showNotification('Error: ' + error.message, 'error');
                }
            } finally {
                hideLoading();
            }
        }

        function copiarCredenciales() {
            const username = document.getElementById('generated-username-display').textContent;
            const password = document.getElementById('generated-password-display').textContent;
            const text = `Usuario: ${username}\nContrase√±a: ${password}`;
            
            navigator.clipboard.writeText(text);
            showNotification('‚úÖ Credenciales copiadas al portapapeles', 'success');
        }

        async function loadUsuariosTable() {
            showLoading('Cargando usuarios...');
            
            try {
                const { data } = await sb.from('usuarios')
                    .select('*, instituciones(nombre)')
                    .order('created_at', { ascending: false });
                
                const table = document.getElementById('usuarios-table');
                if (data && data.length > 0) {
                    table.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Usuario</th>
                                    <th>Nombre</th>
                                    <th>Email</th>
                                    <th>Rol</th>
                                    <th>Instituci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(user => `
                                    <tr>
                                        <td class="font-mono font-bold">${user.username}</td>
                                        <td>${user.nombre_completo || 'N/A'}</td>
                                        <td class="text-xs">${user.email || 'N/A'}</td>
                                        <td><span class="badge badge-${user.rol}">${user.rol.replace('_', ' ').toUpperCase()}</span></td>
                                        <td class="text-xs">${user.instituciones?.nombre || 'N/A'}</td>
                                        <td>
                                            <button onclick="resetPasswordUsuario(${user.id}, '${user.username}')" class="action-btn btn-edit">üîë</button>
                                            <button onclick="eliminarUsuario(${user.id}, '${user.username}')" class="action-btn btn-delete">üóëÔ∏è</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    table.innerHTML = '<p class="text-center text-gray-400 p-8">No hay usuarios registrados</p>';
                }
                
            } catch (error) {
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        async function resetPasswordUsuario(id, username) {
            const newPassword = generateSecurePassword(14);
            
            showModal('üîë Resetear Contrase√±a', `
                <p class="mb-4">Se generar√° una nueva contrase√±a para: <strong>${username}</strong></p>
                <div class="password-display">
                    <div class="text-xs text-gray-400 mb-2">NUEVA CONTRASE√ëA</div>
                    <div id="modal-new-password">${newPassword}</div>
                </div>
                <p class="text-xs text-yellow-600 font-bold mt-3">‚ö†Ô∏è Guarda esta contrase√±a. No podr√°s verla nuevamente.</p>
            `, [{
                text: '‚úÖ Confirmar Reset',
                class: 'bg-green-600 text-white',
                action: `confirmResetPassword(${id}, '${newPassword}', '${username}')`
            }]);
        }

        async function confirmResetPassword(id, newPassword, username) {
            try {
                const { error } = await sb.from('usuarios').update({ password: newPassword }).eq('id', id);
                if (error) throw error;
                
                // Log
                await sb.from('logs_sistema').insert([{
                    accion: 'reset_password',
                    usuario: currentSession.user,
                    detalles: `Reset password para: ${username}`,
                    institucion_id: currentSession.institucion_id
                }]);
                
                showNotification('‚úÖ Contrase√±a actualizada', 'success');
                closeModal();
                
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function eliminarUsuario(id, username) {
            if (username === currentSession.user) {
                return showNotification('No puedes eliminar tu propio usuario', 'error');
            }
            
            if (!confirm(`¬øEliminar usuario ${username}?`)) return;
            
            try {
                const { error } = await sb.from('usuarios').delete().eq('id', id);
                if (error) throw error;
                
                // Log
                await sb.from('logs_sistema').insert([{
                    accion: 'eliminar_usuario',
                    usuario: currentSession.user,
                    detalles: `Usuario eliminado: ${username}`,
                    institucion_id: currentSession.institucion_id
                }]);
                
                showNotification('‚úÖ Usuario eliminado', 'success');
                await loadUsuariosTable();
                
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // LOGS
        async function loadLogsTable() {
            showLoading('Cargando logs...');
            
            try {
                const { data } = await sb.from('logs_sistema')
                    .select('*, instituciones(nombre)')
                    .order('created_at', { ascending: false })
                    .limit(100);
                
                const table = document.getElementById('logs-table');
                if (data && data.length > 0) {
                    table.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha/Hora</th>
                                    <th>Usuario</th>
                                    <th>Acci√≥n</th>
                                    <th>Detalles</th>
                                    <th>Instituci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(log => `
                                    <tr>
                                        <td class="text-xs">${new Date(log.created_at).toLocaleString('es-AR')}</td>
                                        <td class="font-bold">${log.usuario}</td>
                                        <td><span class="badge badge-admin">${log.accion}</span></td>
                                        <td class="text-xs">${log.detalles || '-'}</td>
                                        <td class="text-xs">${log.instituciones?.nombre || 'Sistema'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    table.innerHTML = '<p class="text-center text-gray-400 p-8">Sin logs registrados</p>';
                }
                
            } catch (error) {
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        async function filtrarLogs() {
            const desde = document.getElementById('logs-fecha-desde').value;
            const hasta = document.getElementById('logs-fecha-hasta').value;
            
            if (!desde || !hasta) {
                return showNotification('Selecciona ambas fechas', 'error');
            }
            
            showLoading('Filtrando...');
            
            try {
                const { data } = await sb.from('logs_sistema')
                    .select('*, instituciones(nombre)')
                    .gte('created_at', desde)
                    .lte('created_at', hasta + ' 23:59:59')
                    .order('created_at', { ascending: false });
                
                const table = document.getElementById('logs-table');
                if (data && data.length > 0) {
                    table.innerHTML = `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Fecha/Hora</th>
                                    <th>Usuario</th>
                                    <th>Acci√≥n</th>
                                    <th>Detalles</th>
                                    <th>Instituci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(log => `
                                    <tr>
                                        <td class="text-xs">${new Date(log.created_at).toLocaleString('es-AR')}</td>
                                        <td class="font-bold">${log.usuario}</td>
                                        <td><span class="badge badge-admin">${log.accion}</span></td>
                                        <td class="text-xs">${log.detalles || '-'}</td>
                                        <td class="text-xs">${log.instituciones?.nombre || 'Sistema'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    table.innerHTML = '<p class="text-center text-gray-400 p-8">Sin resultados en ese rango</p>';
                }
                
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // CONFIGURACI√ìN
        async function loadSystemConfig() {
            try {
                const { data: instituciones } = await sb.from('instituciones').select('*');
                const { data: usuarios } = await sb.from('usuarios').select('*');
                const { data: alumnos } = await sb.from('alumnos').select('*');
                const { data: cursos } = await sb.from('cursos').select('*');
                const { data: credenciales } = await sb.from('historial_emisiones').select('*');
                
                const statsDiv = document.getElementById('system-stats');
                statsDiv.innerHTML = `
                    <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                        <p class="text-xs font-bold text-blue-900 mb-1">Instituciones</p>
                        <p class="text-3xl font-black text-blue-600">${instituciones?.length || 0}</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
                        <p class="text-xs font-bold text-purple-900 mb-1">Usuarios</p>
                        <p class="text-3xl font-black text-purple-600">${usuarios?.length || 0}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-xl border-2 border-green-200">
                        <p class="text-xs font-bold text-green-900 mb-1">Alumnos</p>
                        <p class="text-3xl font-black text-green-600">${alumnos?.length || 0}</p>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-xl border-2 border-orange-200">
                        <p class="text-xs font-bold text-orange-900 mb-1">Cursos</p>
                        <p class="text-3xl font-black text-orange-600">${cursos?.length || 0}</p>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-xl border-2 border-indigo-200">
                        <p class="text-xs font-bold text-indigo-900 mb-1">Credenciales</p>
                        <p class="text-3xl font-black text-indigo-600">${credenciales?.length || 0}</p>
                    </div>
                    <div class="bg-pink-50 p-4 rounded-xl border-2 border-pink-200">
                        <p class="text-xs font-bold text-pink-900 mb-1">Almacenamiento</p>
                        <p class="text-3xl font-black text-pink-600">N/A</p>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function exportarTodosSistema() {
            showLoading('Exportando datos...');
            
            try {
                const { data: instituciones } = await sb.from('instituciones').select('*');
                const { data: usuarios } = await sb.from('usuarios').select('*');
                const { data: alumnos } = await sb.from('alumnos').select('*');
                const { data: cursos } = await sb.from('cursos').select('*');
                
                let csv = "TIPO,ID,NOMBRE,DETALLES\n";
                
                instituciones?.forEach(i => csv += `INSTITUCION,${i.id},${i.nombre},"${i.codigo}"\n`);
                usuarios?.forEach(u => csv += `USUARIO,${u.id},${u.username},"${u.rol}"\n`);
                alumnos?.forEach(a => csv += `ALUMNO,${a.dni},${a.nombre_completo},"${a.matricula_arg}"\n`);
                cursos?.forEach(c => csv += `CURSO,${c.id},${c.nombre_curso},""\n`);
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `RENAM_BACKUP_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                showNotification('‚úÖ Exportado exitosamente', 'success');
                
                // Log
                await sb.from('logs_sistema').insert([{
                    accion: 'exportar_sistema',
                    usuario: currentSession.user,
                    detalles: 'Exportaci√≥n completa del sistema',
                    institucion_id: currentSession.institucion_id
                }]);
                
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function verificarIntegridad() {
            showLoading('Verificando integridad...');
            
            try {
                // Verificar alumnos sin instituci√≥n
                const { data: alumnosSinInst } = await sb.from('alumnos').select('*').is('institucion_id', null);
                
                // Verificar cursos sin instituci√≥n
                const { data: cursosSinInst } = await sb.from('cursos').select('*').is('institucion_id', null);
                
                // Verificar usuarios sin instituci√≥n
                const { data: usuariosSinInst } = await sb.from('usuarios').select('*').is('institucion_id', null);
                
                let problemas = [];
                if (alumnosSinInst?.length > 0) problemas.push(`${alumnosSinInst.length} alumnos sin instituci√≥n`);
                if (cursosSinInst?.length > 0) problemas.push(`${cursosSinInst.length} cursos sin instituci√≥n`);
                if (usuariosSinInst?.length > 0) problemas.push(`${usuariosSinInst.length} usuarios sin instituci√≥n`);
                
                hideLoading();
                
                if (problemas.length === 0) {
                    showModal('‚úÖ Integridad Verificada', `
                        <div class="bg-green-50 p-6 rounded-xl border-2 border-green-200 text-center">
                            <div class="text-6xl mb-4">‚úÖ</div>
                            <p class="text-xl font-black text-green-900">Base de Datos √çntegra</p>
                            <p class="text-sm text-green-700 mt-2">No se encontraron problemas</p>
                        </div>
                    `, []);
                } else {
                    showModal('‚ö†Ô∏è Problemas Detectados', `
                        <div class="bg-orange-50 p-6 rounded-xl border-2 border-orange-200">
                            <p class="font-bold text-orange-900 mb-3">Se encontraron los siguientes problemas:</p>
                            <ul class="list-disc list-inside space-y-1 text-sm text-orange-800">
                                ${problemas.map(p => `<li>${p}</li>`).join('')}
                            </ul>
                        </div>
                    `, []);
                }
                
            } catch (error) {
                hideLoading();
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function limpiarLogsAntiguos() {
            if (!confirm('¬øEliminar logs de m√°s de 90 d√≠as?')) return;
            
            showLoading('Limpiando logs...');
            
            try {
                const hace90dias = new Date();
                hace90dias.setDate(hace90dias.getDate() - 90);
                
                const { error } = await sb.from('logs_sistema')
                    .delete()
                    .lt('created_at', hace90dias.toISOString());
                
                if (error) throw error;
                
                showNotification('‚úÖ Logs antiguos eliminados', 'success');
                
                // Log de limpieza
                await sb.from('logs_sistema').insert([{
                    accion: 'limpiar_logs',
                    usuario: currentSession.user,
                    detalles: 'Limpieza de logs >90 d√≠as',
                    institucion_id: currentSession.institucion_id
                }]);
                
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function optimizarBD() {
            showNotification('Funci√≥n disponible pr√≥ximamente', 'info');
        }

        function verDetallesInstitucion(id) {
            showNotification('Funci√≥n disponible pr√≥ximamente', 'info');
        }

        function editarInstitucion(id) {
            showNotification('Funci√≥n disponible pr√≥ximamente', 'info');
        }

        // ADMIN MODE (Sistema Normal)
        async function setupAdminMode() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            showNotification('Panel de administraci√≥n normal (funcionalidad completa del sistema)', 'info');
        }

        // INICIALIZACI√ìN
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading('Inicializando RENAM...');
            
            try {
                const setupComplete = await checkSetupStatus();
                
                if (!setupComplete) {
                    // Mostrar wizard de onboarding
                    hideLoading();
                    document.getElementById('onboarding-screen').classList.remove('hidden');
                    return;
                }
                
                // Sistema ya configurado, cargar instituciones
                await loadInstituciones();
                
                // Verificar sesi√≥n guardada
                const savedSession = localStorage.getItem('renam_session');
                if (savedSession) {
                    try {
                        currentSession = JSON.parse(savedSession);
                        
                        if (currentSession.rol === 'super_admin') {
                            await setupSuperAdminMode();
                        } else {
                            await setupAdminMode();
                        }
                        
                        hideLoading();
                        return;
                    } catch (e) {
                        localStorage.removeItem('renam_session');
                    }
                }
                
                // Mostrar login
                hideLoading();
                document.getElementById('login-screen').classList.remove('hidden');
                
            } catch (error) {
                hideLoading();
                console.error('Error en inicializaci√≥n:', error);
                showNotification('Error al inicializar el sistema', 'error');
            }
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RENAM v4.0 Enterprise - Sistema Completo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary-color: #1e40af;
            --text-blue: #1d4ed8;
            --dark-blue: #172554;
        }
        body { font-family: 'Roboto', sans-serif; background: #f0f2f5; }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }
        .loading-overlay .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
        }
        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 32px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .data-table th {
            background: #1e40af;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        .data-table tr:hover {
            background: #f8fafc;
        }

        .pagination {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination button {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 12px;
            transition: all 0.2s;
        }
        .pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .pagination button.active {
            background: #1e40af;
            color: white;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-super-admin { background: #7c3aed; color: white; }
        .badge-admin { background: #1e40af; color: white; }
        .badge-editor { background: #059669; color: white; }
        .badge-visor { background: #64748b; color: white; }
        .badge-activo { background: #10b981; color: white; }
        .badge-suspendido { background: #ef4444; color: white; }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 24px;
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        .stat-card .number {
            font-size: 48px;
            font-weight: 900;
            line-height: 1;
        }
        .stat-card .label {
            font-size: 14px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 8px;
        }

        #download-area { 
            width: 856px; 
            padding: 20px; 
            background: #e2e8f0; 
            border-radius: 20px; 
            margin: 0 auto; 
        }
        
        .carnet-preview { 
            width: 856px; 
            height: 540px; 
            position: relative; 
            overflow: hidden; 
            background: #ffffff;
            font-family: 'Roboto', sans-serif;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .security-guilloche {
            position: absolute;
            inset: 0;
            z-index: 2;
            pointer-events: none;
            background:
                repeating-linear-gradient(45deg, transparent 0px, transparent 6px, rgba(30, 64, 175, 0.04) 6px, rgba(30, 64, 175, 0.04) 7px),
                repeating-linear-gradient(-45deg, transparent 0px, transparent 6px, rgba(30, 64, 175, 0.04) 6px, rgba(30, 64, 175, 0.04) 7px),
                repeating-linear-gradient(90deg, transparent 0px, transparent 10px, rgba(30, 64, 175, 0.03) 10px, rgba(30, 64, 175, 0.03) 11px),
                repeating-linear-gradient(0deg, transparent 0px, transparent 10px, rgba(30, 64, 175, 0.03) 10px, rgba(30, 64, 175, 0.03) 11px);
            background-size: 100% 100%, 100% 100%, 100% 100%, 100% 100%;
        }

        .holographic-stripe-svg {
            position: absolute;
            top: 0; 
            right: -30px; 
            bottom: 0;
            width: 120px;
            z-index: 5;
            pointer-events: none;
            transform: skewX(-15deg);
        }

        .microprint {
            position: absolute;
            font-size: 4px;
            font-weight: 700;
            color: rgba(30, 64, 175, 0.15);
            letter-spacing: 0.5px;
            line-height: 5px;
            transform: scaleY(0.8);
            z-index: 3;
            overflow: hidden;
            white-space: nowrap;
        }
        .microprint-bottom { bottom: 52px; left: 360px; right: 40px; }
        .microprint-left { bottom: 200px; left: 40px; writing-mode: vertical-lr; transform: rotate(180deg) scaleX(0.8); }
        .microprint-top { top: 90px; left: 360px; right: 40px; }

        .security-rosette {
            position: absolute;
            bottom: 65px;
            right: 55px;
            width: 55px;
            height: 55px;
            opacity: 0.18;
            z-index: 3;
        }

        .header-bar {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 85px;
            background: var(--primary-color); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 50px; 
            z-index: 50; 
            color: white;
        }

        .inst-title {
            font-size: 28px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: -0.5px;
        }

        .id-label {
            font-size: 12px;
            font-weight: 900;
            opacity: 0.85;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .renam-header-logo {
            position: absolute;
            left: 50%; 
            top: 50%;
            transform: translate(-50%, -50%);
            height: 70px; 
            width: 70px;
            background: radial-gradient(circle at 30% 30%, #ffffff, #f0f0f0);
            border-radius: 50%;
            padding: 3px;
            border: 3px solid #fbbf24;
            display: flex; 
            align-items: center; 
            justify-content: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.25);
        }
        
        .renam-text-logo { 
            font-weight: 900; 
            color: var(--primary-color); 
            font-size: 16px; 
            text-align: center; 
            line-height: 0.9;
        }

        .footer-bar {
            position: absolute; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            height: 50px;
            background: var(--primary-color);
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 50px; 
            z-index: 50; 
            color: white;
        }
        
        .footer-text { 
            font-size: 11px; 
            font-weight: 900; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
        }

        #photo-preview {
            position: absolute; 
            top: 115px; 
            left: 50px; 
            width: 280px; 
            height: 340px;
            object-fit: cover; 
            z-index: 10;
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 3px;
        }

        #avales-container { 
            position: absolute; 
            top: 105px; 
            left: 360px; 
            right: 50px;
            display: flex; 
            gap: 18px; 
            align-items: center; 
            height: 60px; 
            z-index: 25;
        }
        
        .aval-logo { 
            height: 50px; 
            width: auto;
            max-width: 75px;
            object-fit: contain;
        }

        #cursos-section { 
            position: absolute; 
            top: 185px; 
            left: 360px; 
            right: 50px; 
            z-index: 20;
            max-height: 180px;
            overflow: hidden;
        }
        
        .curso-item-clean {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-blue);
            text-transform: uppercase;
            margin-bottom: 12px;
            line-height: 1.2;
            display: flex; 
            align-items: flex-start;
        }
        
        .curso-item-clean::before {
            content: '‚Ä¢';
            color: var(--text-blue);
            margin-right: 12px;
            font-size: 22px;
            line-height: 16px;
        }

        #nombre-preview {
            position: absolute; 
            bottom: 160px; 
            left: 360px; 
            right: 50px;
            font-size: 36px; 
            font-weight: 900; 
            color: var(--dark-blue);
            text-transform: uppercase; 
            z-index: 30; 
            line-height: 1.1;
        }

        #dni-container { 
            position: absolute; 
            bottom: 130px; 
            left: 360px; 
            font-size: 18px; 
            font-weight: 600; 
            color: #475569; 
            z-index: 30; 
            text-transform: uppercase;
        }
        
        #matricula-container { 
            position: absolute; 
            bottom: 102px; 
            left: 360px; 
            font-size: 22px; 
            font-weight: 900; 
            color: #000000; 
            z-index: 30; 
        }
        
        #vence-display-preview {
            position: absolute; 
            bottom: 75px; 
            left: 360px; 
            font-size: 13px; 
            font-weight: 700; 
            color: #64748b; 
            z-index: 30;
            text-transform: uppercase;
        }

        .qr-container {
            position: absolute; 
            bottom: 75px; 
            left: 50px;
            z-index: 110;
        }

        .qr-label {
            font-size: 8px;
            font-weight: 900;
            color: var(--primary-color);
            text-align: center;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .qr-box {
            width: 110px; 
            height: 110px;
            background: white; 
            padding: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid #e2e8f0;
            border-radius: 3px;
        }

        #watermark-asari {
            position: absolute; 
            top: 50%; 
            right: 70px; 
            transform: translateY(-50%) rotate(5deg);
            width: 350px; 
            height: 350px; 
            opacity: 0.15;
            z-index: 1; 
            object-fit: contain; 
            pointer-events: none;
        }

        .logo-slot {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 8px;
            min-height: 85px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: #f8fafc;
            transition: all 0.2s;
        }

        .logo-slot:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
        }

        .logo-slot.has-logo {
            border-style: solid;
            border-color: #10b981;
            background: #f0fdf4;
        }

        .logo-slot-preview {
            max-width: 100%;
            max-height: 70px;
            object-fit: contain;
        }

        .logo-remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #ef4444;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            font-weight: 900;
        }

        .watermark-section {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #fbbf24;
        }

        .tab-btn { 
            text-align: center; 
            padding-bottom: 0.5rem; 
            text-transform: uppercase; 
            font-weight: 700; 
            font-size: 0.875rem; 
            color: #94a3b8; 
            transition: all 0.2s; 
            cursor: pointer; 
            border: none; 
            background: none;
        }
        .tab-btn:hover { color: #1e40af; }
        .tab-active { 
            border-bottom: 4px solid var(--primary-color); 
            color: var(--primary-color);
        }

        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #3498db; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            animation: spin 1s linear infinite; 
            display: inline-block; 
            vertical-align: middle; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        .notification {
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 9999;
            padding: 16px 24px; 
            border-radius: 12px; 
            font-weight: 700;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        }
        .notification.success { background: #10b981; color: white; }
        .notification.error { background: #ef4444; color: white; }
        .notification.info { background: #3b82f6; color: white; }
        @keyframes slideIn { 
            from { transform: translateX(400px); opacity: 0; } 
            to { transform: translateX(0); opacity: 1; } 
        }

        .required-field::after {
            content: '*';
            color: #ef4444;
            margin-left: 4px;
            font-weight: 900;
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .btn-edit { background: #3b82f6; color: white; }
        .btn-delete { background: #ef4444; color: white; }
        .btn-view { background: #10b981; color: white; }
        .btn-download { background: #8b5cf6; color: white; }
        .btn-suspend { background: #f59e0b; color: white; }

        .wizard-step {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
        }
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e2e8f0;
            transition: all 0.3s;
        }
        .step-dot.active {
            background: #1e40af;
            width: 40px;
            border-radius: 6px;
        }

        .password-display {
            background: #1e293b;
            color: #10b981;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            font-weight: 900;
            text-align: center;
            letter-spacing: 3px;
            margin: 20px 0;
            position: relative;
        }
        .password-strength {
            font-size: 12px;
            margin-top: 8px;
            font-weight: 700;
        }
        .strength-weak { color: #ef4444; }
        .strength-medium { color: #f59e0b; }
        .strength-strong { color: #10b981; }
    </style>
</head>
<body class="p-4 lg:p-8 min-h-screen">

    <!-- ONBOARDING WIZARD -->
    <div id="onboarding-screen" class="min-h-screen flex items-center justify-center hidden">
        <div class="wizard-step">
            <div class="text-center mb-8">
                <div class="w-24 h-24 bg-gradient-to-br from-purple-600 to-blue-900 rounded-full flex items-center justify-center text-white mx-auto mb-4 shadow-2xl border-4 border-yellow-400">
                    <div class="text-3xl font-black">RENAM</div>
                </div>
                <h1 class="text-3xl font-black text-slate-800 mb-2">¬°Bienvenido a RENAM!</h1>
                <p class="text-sm text-slate-500 font-bold">Configuraci√≥n Inicial del Sistema</p>
            </div>

            <div class="step-indicator">
                <div class="step-dot active" id="step-dot-1"></div>
                <div class="step-dot" id="step-dot-2"></div>
                <div class="step-dot" id="step-dot-3"></div>
            </div>

            <!-- STEP 1: Super Admin -->
            <div id="wizard-step-1">
                <h2 class="text-2xl font-black text-slate-800 mb-4">Crear Super Administrador</h2>
                <p class="text-sm text-slate-600 mb-6">Este ser√° el usuario principal con acceso total al sistema</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Nombre Completo</label>
                        <input type="text" id="wizard-super-nombre" placeholder="Juan P√©rez" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200 focus:ring-purple-600">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Email</label>
                        <input type="email" id="wizard-super-email" placeholder="admin@empresa.com" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200 focus:ring-purple-600">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Usuario</label>
                        <input type="text" id="wizard-super-username" placeholder="superadmin" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200 focus:ring-purple-600">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Contrase√±a</label>
                        <div class="flex gap-2">
                            <input type="password" id="wizard-super-password" placeholder="M√≠nimo 8 caracteres" class="flex-1 p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200 focus:ring-purple-600">
                            <button onclick="togglePasswordVisibility('wizard-super-password')" class="px-4 bg-slate-200 rounded-xl hover:bg-slate-300">üëÅÔ∏è</button>
                        </div>
                        <div id="password-strength-1" class="mt-2 text-xs"></div>
                    </div>
                </div>

                <button onclick="wizardNext(2)" class="w-full mt-6 bg-gradient-to-r from-purple-600 to-blue-900 text-white py-4 rounded-xl font-black text-lg hover:from-purple-500 hover:to-blue-800 transition shadow-xl">
                    Continuar ‚Üí
                </button>
            </div>

            <!-- STEP 2: Primera Instituci√≥n -->
            <div id="wizard-step-2" class="hidden">
                <h2 class="text-2xl font-black text-slate-800 mb-4">Primera Instituci√≥n</h2>
                <p class="text-sm text-slate-600 mb-6">Crea la primera instituci√≥n que usar√° el sistema</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Nombre de la Instituci√≥n</label>
                        <input type="text" id="wizard-inst-nombre" placeholder="Universidad Nacional" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200 focus:ring-purple-600">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Email de Contacto</label>
                        <input type="email" id="wizard-inst-email" placeholder="contacto@universidad.edu" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200 focus:ring-purple-600">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">L√≠mite Alumnos</label>
                            <input type="number" id="wizard-inst-limite-alumnos" placeholder="1000" value="1000" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200 focus:ring-purple-600">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">L√≠mite Usuarios</label>
                            <input type="number" id="wizard-inst-limite-usuarios" placeholder="50" value="50" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200 focus:ring-purple-600">
                        </div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                        <p class="text-xs font-bold text-blue-900 mb-2">C√≥digo de Instituci√≥n (generado autom√°ticamente):</p>
                        <p id="wizard-inst-codigo-preview" class="text-2xl font-black text-blue-600 font-mono">INST-XXXX-2026</p>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="wizardPrev(1)" class="flex-1 bg-slate-200 text-slate-700 py-4 rounded-xl font-black hover:bg-slate-300 transition">
                        ‚Üê Atr√°s
                    </button>
                    <button onclick="wizardNext(3)" class="flex-1 bg-gradient-to-r from-purple-600 to-blue-900 text-white py-4 rounded-xl font-black hover:from-purple-500 hover:to-blue-800 transition shadow-xl">
                        Continuar ‚Üí
                    </button>
                </div>
            </div>

            <!-- STEP 3: Confirmaci√≥n -->
            <div id="wizard-step-3" class="hidden">
                <h2 class="text-2xl font-black text-slate-800 mb-4">üéâ ¬°Listo para Empezar!</h2>
                <p class="text-sm text-slate-600 mb-6">Revisa los datos antes de completar la configuraci√≥n</p>
                
                <div class="space-y-4">
                    <div class="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
                        <p class="text-xs font-bold text-purple-900 mb-2">SUPER ADMINISTRADOR</p>
                        <p id="wizard-confirm-super" class="text-sm font-bold text-purple-700"></p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                        <p class="text-xs font-bold text-blue-900 mb-2">INSTITUCI√ìN</p>
                        <p id="wizard-confirm-inst" class="text-sm font-bold text-blue-700"></p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-xl border-2 border-green-200">
                        <p class="text-xs font-bold text-green-900 mb-2">‚úÖ CONFIGURACI√ìN LISTA</p>
                        <ul class="text-sm text-green-700 space-y-1 list-disc list-inside">
                            <li>Base de datos configurada</li>
                            <li>Super Admin creado</li>
                            <li>Primera instituci√≥n lista</li>
                            <li>Sistema listo para usar</li>
                        </ul>
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button onclick="wizardPrev(2)" class="flex-1 bg-slate-200 text-slate-700 py-4 rounded-xl font-black hover:bg-slate-300 transition">
                        ‚Üê Atr√°s
                    </button>
                    <button onclick="completeSetup()" class="flex-1 bg-gradient-to-r from-green-600 to-green-800 text-white py-4 rounded-xl font-black hover:from-green-500 hover:to-green-700 transition shadow-xl">
                        üöÄ Completar Setup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center hidden">
        <div class="bg-white p-10 rounded-3xl shadow-2xl max-w-md w-full border-t-8 border-blue-900">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-blue-900 rounded-full flex items-center justify-center text-white mx-auto mb-4 shadow-xl border-4 border-yellow-600">
                    <div class="text-2xl font-black">RENAM</div>
                </div>
                <h1 class="text-3xl font-black text-blue-900 mb-2">RENAM v4.0</h1>
                <p class="text-sm text-gray-500 font-bold">Enterprise Edition</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">Usuario</label>
                    <input type="text" id="login-username" placeholder="Ingrese usuario" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200 focus:ring-blue-600" required>
                </div>
                
                <div>
                    <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">Contrase√±a</label>
                    <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200 focus:ring-blue-600" required>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">Instituci√≥n</label>
                    <select id="login-institucion" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200 focus:ring-blue-600" required>
                        <option value="">Cargando...</option>
                    </select>
                </div>
                
                <button type="submit" id="login-btn" class="w-full bg-gradient-to-r from-blue-900 to-blue-700 text-white py-5 rounded-xl font-black text-lg hover:from-blue-800 hover:to-blue-600 transition-all shadow-xl uppercase">
                    üîê Iniciar Sesi√≥n
                </button>
            </form>
        </div>
    </div>

    <!-- SUPER ADMIN PANEL -->
    <div id="superadmin-panel" class="max-w-7xl mx-auto hidden">
        <header class="bg-gradient-to-r from-purple-600 to-blue-900 p-6 rounded-3xl shadow-lg mb-8 text-white">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-xl border-4 border-yellow-400">
                        <div class="text-center">
                            <div class="text-xl font-black text-purple-600">RENAM</div>
                        </div>
                    </div>
                    <div>
                        <h1 class="text-2xl font-black">Panel Super Admin</h1>
                        <p class="text-xs opacity-90 font-bold" id="superadmin-user-info">Cargando...</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="logout()" class="bg-red-600 text-white px-6 py-2 rounded-xl font-bold text-sm hover:bg-red-700 transition">
                        üö™ Cerrar Sesi√≥n
                    </button>
                </div>
            </div>
            <nav class="flex gap-6 mt-6">
                <button onclick="switchSuperAdminTab('dashboard')" id="sa-tab-dashboard" class="tab-btn tab-active text-white">
                    <span>üìä Dashboard</span>
                </button>
                <button onclick="switchSuperAdminTab('instituciones')" id="sa-tab-instituciones" class="tab-btn text-white">
                    <span>üè¢ Instituciones</span>
                </button>
                <button onclick="switchSuperAdminTab('usuarios')" id="sa-tab-usuarios" class="tab-btn text-white">
                    <span>üë• Usuarios</span>
                </button>
                <button onclick="switchSuperAdminTab('logs')" id="sa-tab-logs" class="tab-btn text-white">
                    <span>üìú Logs</span>
                </button>
                <button onclick="switchSuperAdminTab('config')" id="sa-tab-config" class="tab-btn text-white">
                    <span>‚öôÔ∏è Config</span>
                </button>
            </nav>
        </header>

        <!-- TAB: DASHBOARD -->
        <div id="sa-content-dashboard">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="number" id="stat-instituciones">0</div>
                    <div class="label">Instituciones Activas</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="number" id="stat-usuarios">0</div>
                    <div class="label">Usuarios Totales</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="number" id="stat-credenciales">0</div>
                    <div class="label">Credenciales Emitidas</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-black text-slate-800 mb-4">üìà Actividad Reciente</h3>
                    <div id="recent-activity" class="space-y-3"></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-black text-slate-800 mb-4">‚ö†Ô∏è Alertas</h3>
                    <div id="alerts-list" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <!-- TAB: INSTITUCIONES -->
        <div id="sa-content-instituciones" class="hidden">
            <div class="bg-white p-8 rounded-3xl shadow-xl mb-6">
                <h2 class="text-2xl font-black text-slate-800 mb-6">‚ûï Nueva Instituci√≥n</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Nombre Instituci√≥n</label>
                        <input type="text" id="sa-inst-nombre" placeholder="Universidad XYZ" class="w-full p-3 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Email Contacto</label>
                        <input type="email" id="sa-inst-email" placeholder="contacto@universidad.edu" class="w-full p-3 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">L√≠mite Alumnos</label>
                        <input type="number" id="sa-inst-limite-alumnos" placeholder="1000" value="1000" class="w-full p-3 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">L√≠mite Usuarios</label>
                        <input type="number" id="sa-inst-limite-usuarios" placeholder="50" value="50" class="w-full p-3 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200">
                    </div>
                </div>
                <div class="mt-4 flex gap-3">
                    <button onclick="crearInstitucion()" class="flex-1 bg-gradient-to-r from-purple-600 to-blue-900 text-white py-4 rounded-xl font-black hover:from-purple-500 hover:to-blue-800 transition shadow-xl">
                        üè¢ Crear Instituci√≥n
                    </button>
                    <button onclick="limpiarFormInstitucion()" class="px-6 bg-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-300">
                        üîÑ Limpiar
                    </button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-black text-slate-800">Instituciones Registradas</h3>
                    <input type="text" id="search-instituciones" placeholder="üîç Buscar..." class="p-2 bg-slate-50 rounded-lg text-sm font-bold ring-1 ring-slate-200">
                </div>
                <div id="instituciones-table"></div>
            </div>
        </div>

        <!-- TAB: USUARIOS -->
        <div id="sa-content-usuarios" class="hidden">
            <div class="bg-white p-8 rounded-3xl shadow-xl mb-6">
                <h2 class="text-2xl font-black text-slate-800 mb-6">üë§ Nuevo Usuario</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Instituci√≥n</label>
                        <select id="sa-user-institucion" class="w-full p-3 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Rol</label>
                        <select id="sa-user-rol" class="w-full p-3 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200">
                            <option value="admin">Admin</option>
                            <option value="editor">Editor</option>
                            <option value="visor">Visor</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Nombre Completo</label>
                        <input type="text" id="sa-user-nombre" placeholder="Juan P√©rez" class="w-full p-3 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Email</label>
                        <input type="email" id="sa-user-email" placeholder="usuario@email.com" class="w-full p-3 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Usuario (generado auto)</label>
                        <input type="text" id="sa-user-username" placeholder="Se genera autom√°ticamente" class="w-full p-3 bg-slate-100 rounded-xl font-bold ring-2 ring-slate-200" readonly>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Contrase√±a</label>
                        <div class="flex gap-2">
                            <input type="text" id="sa-user-password" placeholder="Se genera autom√°ticamente" class="flex-1 p-3 bg-slate-100 rounded-xl font-bold ring-2 ring-slate-200" readonly>
                            <button onclick="generarPassword()" class="px-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">üé≤</button>
                        </div>
                    </div>
                </div>
                <div id="password-display-area" class="hidden mt-4">
                    <div class="password-display">
                        <div class="text-xs text-gray-400 mb-2">CREDENCIALES GENERADAS</div>
                        <div>Usuario: <span id="generated-username-display"></span></div>
                        <div>Password: <span id="generated-password-display"></span></div>
                        <div class="password-strength" id="password-strength-display"></div>
                    </div>
                    <p class="text-xs text-yellow-600 font-bold mt-2">‚ö†Ô∏è Guarda estas credenciales. No podr√°s verlas nuevamente.</p>
                </div>
                <div class="mt-4 flex gap-3">
                    <button onclick="crearUsuario()" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-800 text-white py-4 rounded-xl font-black hover:from-blue-500 hover:to-blue-700 transition shadow-xl">
                        üë§ Crear Usuario
                    </button>
                    <button onclick="copiarCredenciales()" id="copy-credentials-btn" class="px-6 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 hidden">
                        üìã Copiar
                    </button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-black text-slate-800">Usuarios del Sistema</h3>
                    <input type="text" id="search-usuarios" placeholder="üîç Buscar..." class="p-2 bg-slate-50 rounded-lg text-sm font-bold ring-1 ring-slate-200">
                </div>
                <div id="usuarios-table"></div>
            </div>
        </div>

        <!-- TAB: LOGS -->
        <div id="sa-content-logs" class="hidden">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-black text-slate-800">üìú Registro de Actividad</h3>
                    <div class="flex gap-2">
                        <input type="date" id="logs-fecha-desde" class="p-2 bg-slate-50 rounded-lg text-sm font-bold">
                        <input type="date" id="logs-fecha-hasta" class="p-2 bg-slate-50 rounded-lg text-sm font-bold">
                        <button onclick="filtrarLogs()" class="px-4 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">Filtrar</button>
                    </div>
                </div>
                <div id="logs-table"></div>
            </div>
        </div>

        <!-- TAB: CONFIG -->
        <div id="sa-content-config" class="hidden">
            <div class="bg-white p-8 rounded-3xl shadow-xl">
                <h2 class="text-2xl font-black text-slate-800 mb-6">‚öôÔ∏è Configuraci√≥n del Sistema</h2>
                
                <div class="space-y-6">
                    <div class="border-b pb-6">
                        <h3 class="text-lg font-black text-slate-700 mb-3">üóÑÔ∏è Base de Datos</h3>
                        <div class="flex gap-3">
                            <button onclick="exportarTodosSistema()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700">
                                üì• Exportar Todo (CSV)
                            </button>
                            <button onclick="verificarIntegridad()" class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-bold hover:bg-purple-700">
                                ‚úÖ Verificar Integridad
                            </button>
                        </div>
                    </div>

                    <div class="border-b pb-6">
                        <h3 class="text-lg font-black text-slate-700 mb-3">üîÑ Mantenimiento</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="limpiarLogsAntiguos()" class="bg-orange-600 text-white py-3 rounded-xl font-bold hover:bg-orange-700">
                                üßπ Limpiar Logs (>90 d√≠as)
                            </button>
                            <button onclick="optimizarBD()" class="bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700">
                                ‚ö° Optimizar BD
                            </button>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-black text-slate-700 mb-3">üìä Estad√≠sticas</h3>
                        <div id="system-stats" class="grid grid-cols-2 gap-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL (Sistema Normal) -->
    <div id="admin-panel" class="max-w-7xl mx-auto hidden">
        <!-- [El c√≥digo del admin panel normal va aqu√≠ - es muy largo, lo resumo] -->
        <div class="text-center py-20">
            <h1 class="text-4xl font-black text-slate-800">Panel de Administraci√≥n</h1>
            <p class="text-slate-600 mt-4">Contenido del sistema normal (generador de credenciales, etc.)</p>
            <button onclick="logout()" class="mt-6 bg-red-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-red-700">
                Cerrar Sesi√≥n
            </button>
        </div>
    </div>

    <script>
        const CONFIG = {
            supabaseUrl: 'https://fuxnsebrhxxbalqfmtzs.supabase.co',
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1eG5zZWJyaHh4YmFscWZtdHpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc0Nzc2NzAsImV4cCI6MjA1MzA1MzY3MH0.fH3SZw8Y2V0ZOTr-_bsv5LXy0gxj2VPnBzLqo5M2n6E'
        };

        const sb = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);

        let currentSession = null;

        // UTILIDADES
        function showNotification(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `notification ${type}`;
            div.textContent = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function showLoading(text = 'Cargando...') {
            const existing = document.querySelector('.loading-overlay');
            if (existing) return;
            const div = document.createElement('div');
            div.className = 'loading-overlay';
            div.innerHTML = `<div class="spinner"></div><p class="text-white font-bold text-xl">${text}</p>`;
            document.body.appendChild(div);
        }

        function hideLoading() {
            const loading = document.querySelector('.loading-overlay');
            if (loading) loading.remove();
        }

        function showModal(title, content, buttons = []) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="text-2xl font-black text-slate-800 mb-4">${title}</h2>
                    <div class="mb-6">${content}</div>
                    <div class="flex gap-3 justify-end">
                        ${buttons.map(btn => `<button onclick="${btn.action}" class="action-btn ${btn.class}">${btn.text}</button>`).join('')}
                        <button onclick="closeModal()" class="action-btn bg-gray-500 text-white">Cerrar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };
        }

        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) modal.remove();
        }

        function sanitizeInput(str) {
            return str.trim().replace(/[<>\"\']/g, '');
        }

        function generateSecurePassword(length = 12) {
            const lowercase = 'abcdefghijklmnopqrstuvwxyz';
            const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const numbers = '0123456789';
            const symbols = '!@#$%^&*()_+-=[]{}|;:,.<>?';
            const all = lowercase + uppercase + numbers + symbols;
            
            let password = '';
            password += lowercase[Math.floor(Math.random() * lowercase.length)];
            password += uppercase[Math.floor(Math.random() * uppercase.length)];
            password += numbers[Math.floor(Math.random() * numbers.length)];
            password += symbols[Math.floor(Math.random() * symbols.length)];
            
            for (let i = 4; i < length; i++) {
                password += all[Math.floor(Math.random() * all.length)];
            }
            
            return password.split('').sort(() => Math.random() - 0.5).join('');
        }

        function checkPasswordStrength(password) {
            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;
            
            if (strength <= 2) return { level: 'weak', text: 'D√©bil', class: 'strength-weak' };
            if (strength <= 4) return { level: 'medium', text: 'Media', class: 'strength-medium' };
            return { level: 'strong', text: 'Fuerte', class: 'strength-strong' };
        }

        function generateInstitucionCode() {
            const year = new Date().getFullYear();
            const random = Math.floor(1000 + Math.random() * 9000);
            return `INST-${random}-${year}`;
        }

        function generateUsername(nombre) {
            const parts = nombre.toLowerCase().split(' ');
            const firstName = parts[0] || 'user';
            const lastName = parts[parts.length - 1] || '';
            const random = Math.floor(100 + Math.random() * 900);
            return `${firstName}.${lastName}${random}`.replace(/[^a-z0-9.]/g, '');
        }

        // ONBOARDING WIZARD
        let wizardData = {
            superAdmin: {},
            institucion: {},
            codigo: generateInstitucionCode()
        };

        function wizardNext(step) {
            if (step === 2) {
                const nombre = document.getElementById('wizard-super-nombre').value.trim();
                const email = document.getElementById('wizard-super-email').value.trim();
                const username = document.getElementById('wizard-super-username').value.trim();
                const password = document.getElementById('wizard-super-password').value;
                
                if (!nombre || !email || !username || !password) {
                    return showNotification('Completa todos los campos', 'error');
                }
                
                if (password.length < 8) {
                    return showNotification('La contrase√±a debe tener al menos 8 caracteres', 'error');
                }
                
                wizardData.superAdmin = { nombre, email, username, password };
                document.getElementById('wizard-inst-codigo-preview').textContent = wizardData.codigo;
            }
            
            if (step === 3) {
                const nombre = document.getElementById('wizard-inst-nombre').value.trim();
                const email = document.getElementById('wizard-inst-email').value.trim();
                const limiteAlumnos = document.getElementById('wizard-inst-limite-alumnos').value;
                const limiteUsuarios = document.getElementById('wizard-inst-limite-usuarios').value;
                
                if (!nombre || !email) {
                    return showNotification('Completa los campos obligatorios', 'error');
                }
                
                wizardData.institucion = { nombre, email, limiteAlumnos, limiteUsuarios };
                
                document.getElementById('wizard-confirm-super').textContent = 
                    `${wizardData.superAdmin.nombre} (${wizardData.superAdmin.username})`;
                document.getElementById('wizard-confirm-inst').textContent = 
                    `${wizardData.institucion.nombre} - ${wizardData.codigo}`;
            }
            
            document.getElementById(`wizard-step-${step - 1}`).classList.add('hidden');
            document.getElementById(`wizard-step-${step}`).classList.remove('hidden');
            document.getElementById(`step-dot-${step - 1}`).classList.remove('active');
            document.getElementById(`step-dot-${step}`).classList.add('active');
        }

        function wizardPrev(step) {
            document.getElementById(`wizard-step-${step + 1}`).classList.add('hidden');
            document.getElementById(`wizard-step-${step}`).classList.remove('hidden');
            document.getElementById(`step-dot-${step + 1}`).classList.remove('active');
            document.getElementById(`step-dot-${step}`).classList.add('active');
        }

        async function completeSetup() {
            showLoading('Configurando sistema...');
            
            try {
                // 1. Crear instituci√≥n
                const { data: inst, error: instError } = await sb.from('instituciones').insert([{
                    nombre: wizardData.institucion.nombre,
                    codigo: wizardData.codigo,
                    email: wizardData.institucion.email,
                    limite_alumnos: parseInt(wizardData.institucion.limiteAlumnos),
                    limite_usuarios: parseInt(wizardData.institucion.limiteUsuarios),
                    estado: 'activo'
                }]).select().single();
                
                if (instError) throw new Error('Error creando instituci√≥n: ' + instError.message);
                
                // 2. Crear super admin
                const { error: userError } = await sb.from('usuarios').insert([{
                    username: wizardData.superAdmin.username,
                    password: wizardData.superAdmin.password,
                    nombre_completo: wizardData.superAdmin.nombre,
                    email: wizardData.superAdmin.email,
                    rol: 'super_admin',
                    institucion_id: inst.id
                }]);
                
                if (userError) throw new Error('Error creando usuario: ' + userError.message);
                
                // 3. Log de configuraci√≥n inicial
                await sb.from('logs_sistema').insert([{
                    accion: 'setup_completado',
                    usuario: wizardData.superAdmin.username,
                    detalles: `Sistema configurado. Instituci√≥n: ${wizardData
