<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Integral SAS v19.0 - ASARIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #1e3a8a; --accent-color: #2563eb; }
        body { font-family: 'Roboto', sans-serif; background: #f1f5f9; }
        
        /* Estilos del Carnet (Mantenidos de v18.0) */
        #download-area { width: 856px; padding: 20px; background: #e5e7eb; border-radius: 20px; }
        .carnet-preview { width: 856px; height: 540px; position: relative; overflow: hidden; background-color: #ffffff; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
        .security-bg { position: absolute; inset: 0; background: repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(30, 58, 138, 0.03) 35px, rgba(30, 58, 138, 0.03) 36px), repeating-linear-gradient(-45deg, transparent, transparent 35px, rgba(30, 58, 138, 0.03) 35px, rgba(30, 58, 138, 0.03) 36px); z-index: 1; }
        .bar-style { position: absolute; left: 0; width: 100%; height: 60px; background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%); display: flex; align-items: center; justify-content: space-between; padding: 0 35px; z-index: 100; }
        .header-bar { top: 0; border-bottom: 3px solid rgba(255,255,255,0.2); }
        .footer-bar { bottom: 0; border-top: 3px solid rgba(255,255,255,0.2); }
        #photo-preview { position: absolute; top: 60px; left: 0; width: 320px; height: 420px; object-fit: cover; z-index: 10; border-bottom-right-radius: 30px; }
        #watermark-preview { position: absolute; top: 50%; right: 40px; transform: translateY(-50%); width: 300px; height: 300px; object-fit: contain; opacity: 0.08; z-index: 5; }
        .qr-box { position: absolute; bottom: 75px; left: 20px; width: 120px; height: 120px; background: white; padding: 8px; z-index: 110; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #nombre-preview { position: absolute; bottom: 140px; left: 355px; font-size: 38px; font-weight: 900; color: var(--primary-color); text-transform: uppercase; z-index: 30; }
        #dni-display-preview { position: absolute; bottom: 115px; left: 355px; font-size: 18px; font-weight: 700; color: #4b5563; z-index: 30; }
        #codigo-preview { position: absolute; bottom: 85px; left: 355px; font-size: 26px; font-weight: 700; color: #111827; z-index: 30; }
        #vence-display-preview { position: absolute; bottom: 65px; left: 355px; font-size: 14px; color: #b91c1c; font-weight: 900; z-index: 30; }
        
        .tab-active { border-bottom: 4px solid var(--primary-color); color: var(--primary-color); font-weight: 900; }
    </style>
</head>
<body class="p-4 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="bg-white p-6 rounded-3xl shadow-lg mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-900 rounded-2xl flex items-center justify-center text-white font-black text-xl">S</div>
                <div>
                    <h1 class="text-2xl font-black text-slate-800 tracking-tighter uppercase italic">Panel Integral SAS Córdoba</h1>
                    <p class="text-xs font-bold text-slate-400">Gestión de Acreditaciones Profesionales</p>
                </div>
            </div>
            <nav class="flex gap-8">
                <button onclick="switchTab('manual')" id="tab-manual" class="pb-2 text-sm uppercase font-bold tab-active">Emisión Manual</button>
                <button onclick="switchTab('admin')" id="tab-admin" class="pb-2 text-sm uppercase font-bold text-slate-400">Gestión Masiva / Alumnos</button>
            </nav>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            
            <section id="form-container" class="bg-white p-8 rounded-3xl shadow-2xl">
                
                <div id="content-manual">
                    <h2 class="text-xl font-black text-blue-900 mb-6 uppercase">Generador Individual</h2>
                    <form id="carnet-form" class="space-y-4">
                        <input type="text" id="institucion" placeholder="NOMBRE INSTITUCIÓN" class="w-full p-4 bg-slate-50 rounded-2xl font-black ring-1 ring-slate-200">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="color" id="color-picker" value="#1e3a8a" class="w-full h-12 p-1 bg-white border rounded-xl">
                            <div class="p-3 border-2 border-dashed rounded-xl"><input type="file" id="watermark-upload" class="text-xs"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="nombre" placeholder="NOMBRE COMPLETO" class="w-full p-4 bg-slate-50 rounded-2xl font-black uppercase">
                            <input type="text" id="dni" placeholder="DNI" class="w-full p-4 bg-slate-50 rounded-2xl font-black">
                        </div>
                        <div class="p-3 border-2 border-dashed rounded-xl"><label class="text-[10px] font-bold block mb-1 uppercase">Foto Alumno</label><input type="file" id="photo-upload" class="text-xs"></div>
                        <textarea id="roles" placeholder="Especialidades..." class="w-full p-4 bg-slate-50 rounded-2xl h-24 font-bold"></textarea>
                        <button type="submit" class="w-full bg-blue-900 text-white py-5 rounded-2xl font-black text-xl hover:bg-black transition-all">EMITIR AHORA</button>
                    </form>
                </div>

                <div id="content-admin" class="hidden">
                    <h2 class="text-xl font-black text-blue-900 mb-6 uppercase tracking-tighter">Módulo de Autogestión (Self-Service)</h2>
                    <div class="space-y-6">
                        <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100">
                            <p class="text-sm font-bold text-blue-800 mb-4 uppercase">1. Pre-registrar Alumno</p>
                            <div class="flex gap-2">
                                <input type="text" id="admin-dni" placeholder="DNI del Alumno" class="flex-1 p-4 rounded-xl border-none ring-1 ring-blue-200">
                                <button onclick="generateInviteLink()" class="bg-blue-600 text-white px-6 rounded-xl font-black">Crear Link</button>
                            </div>
                        </div>
                        
                        <div id="invite-result" class="hidden p-4 bg-slate-100 rounded-xl break-all">
                            <p class="text-[10px] font-bold text-slate-500 uppercase mb-2">Copiar este link para el alumno:</p>
                            <code id="generated-link" class="text-xs text-blue-700 font-mono"></code>
                        </div>

                        <div class="pt-6 border-t">
                            <h3 class="font-black text-slate-800 mb-4 uppercase">Listado y Exportación</h3>
                            <button onclick="exportData()" class="w-full bg-green-600 text-white py-4 rounded-xl font-black mb-4">Exportar Base de Datos a CSV</button>
                            <button onclick="clearData()" class="w-full text-red-500 text-xs font-bold py-2">Limpiar Historial SAS</button>
                        </div>
                    </div>
                </div>
            </section>

            <section class="flex flex-col items-center sticky top-8">
                <div id="download-area">
                    <div id="preview-container" class="carnet-preview">
                        <div class="security-bg"></div>
                        <div class="bar-style header-bar"><span id="institucion-preview" class="text-white font-bold text-xl uppercase tracking-tighter">ASOCIACIÓN ARGENTINA DE INSTRUCTORES</span><span class="text-white text-[10px] font-black opacity-70">PROFESSIONAL ID</span></div>
                        <div class="bar-style footer-bar"><span class="text-white text-[10px] font-black opacity-70 italic uppercase">Sistema SAS Córdoba</span><span class="text-white text-[10px] font-black uppercase">Válido Argentina</span></div>
                        <img id="photo-preview" src="https://placehold.co/320x420/e2e8f0/64748b?text=FOTO" alt="Foto">
                        <img id="watermark-preview" src="" alt="">
                        <div id="logos-header" class="absolute top-[75px] left-[345px] flex gap-4"></div>
                        <div id="roles-container"></div>
                        <div id="nombre-preview">Nombre del Titular</div>
                        <div id="dni-display-preview">DNI: 00.000.000</div>
                        <div id="codigo-preview">MATRÍCULA: ARG-00000000</div>
                        <div id="vence-display-preview">VENCE: --/--/----</div>
                        <div class="qr-box"><canvas id="qr-code-preview"></canvas></div>
                    </div>
                </div>
                <div class="mt-8 flex gap-4">
                    <button onclick="download('png')" class="bg-slate-800 text-white px-10 py-4 rounded-2xl font-black shadow-lg">Descargar PNG</button>
                    <button onclick="download('jpeg')" class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black shadow-lg">Descargar JPG</button>
                </div>
            </section>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
    <script>
        function switchTab(tab) {
            document.getElementById('content-manual').classList.toggle('hidden', tab !== 'manual');
            document.getElementById('content-admin').classList.toggle('hidden', tab !== 'admin');
            document.getElementById('tab-manual').className = `pb-2 text-sm uppercase font-bold ${tab === 'manual' ? 'tab-active' : 'text-slate-400'}`;
            document.getElementById('tab-admin').className = `pb-2 text-sm uppercase font-bold ${tab === 'admin' ? 'tab-active' : 'text-slate-400'}`;
        }

        function generateInviteLink() {
            const dni = document.getElementById('admin-dni').value;
            if(!dni) return alert("Ingresa un DNI");
            const baseUrl = window.location.href.split('?')[0];
            const inviteUrl = `${baseUrl}?mode=student&token=${btoa(dni)}`;
            document.getElementById('generated-link').textContent = inviteUrl;
            document.getElementById('invite-result').classList.remove('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('carnet-form');
            const colorPicker = document.getElementById('color-picker');

            colorPicker.oninput = (e) => {
                document.documentElement.style.setProperty('--primary-color', e.target.value);
                document.documentElement.style.setProperty('--accent-color', e.target.value + 'cc');
            };

            // Lógica de Foto y Textos
            document.getElementById('photo-upload').onchange = (e) => {
                const r = new FileReader(); r.onload = (ev) => document.getElementById('photo-preview').src = ev.target.result;
                r.readAsDataURL(e.target.files[0]);
            };

            form.oninput = (e) => {
                const id = e.target.id; const val = e.target.value;
                if(id === 'roles') document.getElementById('roles-container').innerHTML = val.split('\n').map(l => `<div>• ${l}</div>`).join('');
                else if(id === 'dni') document.getElementById('dni-display-preview').textContent = `DNI: ${val}`;
                else if(document.getElementById(id+'-preview')) document.getElementById(id+'-preview').textContent = val;
            };

            form.onsubmit = (e) => {
                e.preventDefault();
                const dni = document.getElementById('dni').value;
                let matricula = localStorage.getItem('sas_mat_' + dni);
                if (!matricula) {
                    matricula = `ARG-${Math.floor(10000000 + Math.random() * 90000000)}`;
                    localStorage.setItem('sas_mat_' + dni, matricula);
                }
                
                const vence = new Date(); vence.setFullYear(new Date().getFullYear() + 1);
                const venceStr = vence.toLocaleDateString('es-AR');
                
                document.getElementById('codigo-preview').textContent = `MATRÍCULA: ${matricula}`;
                document.getElementById('vence-display-preview').textContent = `VENCE: ${venceStr}`;
                
                // Guardar para exportación
                localStorage.setItem('alumno_data_' + dni, JSON.stringify({
                    dni, nombre: document.getElementById('nombre').value, matricula, vencimiento: venceStr, roles: document.getElementById('roles').value
                }));

                new QRious({ 
                    element: document.getElementById('qr-code-preview'), 
                    value: `https://instructormap.github.io/verificador-Carnet-Oficial/?id=${matricula}`, 
                    size: 105, level: 'H' 
                });
            };
        });

        function download(f) {
            html2canvas(document.getElementById('preview-container'), { scale: 3, useCORS: true }).then(c => {
                const l = document.createElement('a'); l.download = `CARNET_SAS_${Date.now()}.${f==='jpeg'?'jpg':'png'}`;
                l.href = c.toDataURL(`image/${f}`, 1.0); l.click();
            });
        }
        
        function exportData() {
            let csv = "DNI,Nombre,Matricula,Vence\n";
            Object.keys(localStorage).filter(k => k.startsWith('alumno_data_')).forEach(k => {
                const d = JSON.parse(localStorage.getItem(k));
                csv += `${d.dni},${d.nombre},${d.matricula},${d.vencimiento}\n`;
            });
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'Alumnos_SAS.csv'; a.click();
        }
    </script>
</body>
</html>
