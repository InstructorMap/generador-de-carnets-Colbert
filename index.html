<div id="password-display-area" class="hidden mt-4"><div class="password-display"><div class="text-xs mb-2">CREDENCIALES</div><div>Usuario: <span id="gen-username"></span></div><div>Password: <span id="gen-password"></span></div></div></div>
                <div class="flex gap-3 mt-4">
                    <button onclick="crearUsuario()" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-800 text-white py-4 rounded-xl font-black shadow-xl">üë§ Crear</button>
                    <button onclick="copiarCreds()" id="copy-btn" class="px-6 bg-green-600 text-white rounded-xl font-bold hidden">üìã</button>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-black mb-4">Usuarios</h3><div id="usuarios-table"></div></div>
        </div>
        <div id="sa-content-logs" class="hidden">
            <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-black mb-4">üìú Logs</h3><div id="logs-table"></div></div>
        </div>
    </div>

    <!-- ==================== ADMIN PANEL (GENERADOR) ==================== -->
    <div id="admin-panel" class="max-w-7xl mx-auto hidden">
        <header class="bg-white p-6 rounded-3xl shadow-lg mb-8">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-900 rounded-full flex items-center justify-center text-white shadow-xl border-4 border-yellow-600">
                        <div class="text-xl font-black">RENAM</div>
                    </div>
                    <div><h1 class="text-2xl font-black text-slate-800">RENAM v4.0</h1><p class="text-xs text-blue-600 font-bold">Sistema de Credenciales</p><p class="text-xs text-slate-500 font-semibold" id="admin-user-info"></p></div>
                </div>
                <div class="flex items-center gap-4">
                    <span id="admin-role-badge" class="badge"></span>
                    <button onclick="logout()" class="bg-red-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-red-700">üö™ Salir</button>
                </div>
            </div>
            <nav class="flex gap-6 mt-6">
                <button onclick="switchAdminTab('generador')" id="admin-tab-generador" class="tab-btn tab-active">üìù Generador</button>
                <button onclick="switchAdminTab('alumnos')" id="admin-tab-alumnos" class="tab-btn">üë• Alumnos</button>
                <button onclick="switchAdminTab('cursos')" id="admin-tab-cursos" class="tab-btn">üìö Cursos</button>
            </nav>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <section class="bg-white p-8 rounded-3xl shadow-xl">
                <div id="admin-content-generador">
                    <form id="carnet-form" class="space-y-4">
                        <input type="text" id="institucion" placeholder="INSTITUCI√ìN" class="w-full p-4 bg-slate-50 rounded-2xl font-black uppercase" readonly>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="dni" placeholder="DNI (sin puntos)" maxlength="8" class="w-full p-4 bg-slate-50 rounded-2xl font-bold">
                            <input type="text" id="nombre" placeholder="NOMBRE COMPLETO" class="w-full p-4 bg-slate-50 rounded-2xl font-bold uppercase">
                        </div>
                        <div class="bg-blue-50 p-4 rounded-2xl border-2 border-blue-200">
                            <label class="text-xs font-bold text-blue-900 uppercase mb-2 block">Cursos</label>
                            <input type="text" id="curso-search" placeholder="üîç Buscar..." class="w-full p-2 bg-white rounded-lg text-sm font-bold mb-2">
                            <select id="curso-select" multiple size="4" class="w-full p-3 bg-white rounded-xl font-bold text-blue-900"></select>
                            <div id="selected-count" class="text-xs font-bold text-blue-700 mt-2">0 cursos</div>
                            <div class="mt-3 pt-3 border-t-2 border-blue-300 flex gap-2">
                                <input type="text" id="quick-course-name" placeholder="Crear curso..." class="flex-1 p-2 bg-white rounded-lg text-sm font-bold">
                                <button type="button" onclick="quickAddCourse()" class="bg-blue-600 text-white px-4 rounded-lg font-bold">‚ûï</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-600 uppercase mb-1 block">Foto del Alumno</label>
                            <input type="file" id="photo-upload" accept="image/*" class="w-full p-3 border-2 border-dashed rounded-xl bg-slate-50">
                        </div>
                        <div class="bg-gradient-to-br from-yellow-50 to-orange-50 p-4 rounded-2xl border-2 border-yellow-200">
                            <label class="text-xs font-bold text-orange-900 uppercase mb-3 block">üèÖ Logos (hasta 5)</label>
                            <div class="grid grid-cols-5 gap-2" id="logos-grid"></div>
                        </div>
                        <div class="watermark-section p-4 rounded-2xl">
                            <label class="text-xs font-bold text-yellow-900 uppercase mb-2 block">üî∞ Marca de Agua</label>
                            <input type="file" id="watermark-upload" accept="image/*" class="w-full p-3 border-2 border-dashed rounded-xl bg-white text-xs">
                            <div class="mt-2 flex items-center gap-3">
                                <label class="text-xs font-bold">Opacidad:</label>
                                <input type="range" id="watermark-opacity" min="5" max="30" value="15" class="flex-1">
                                <span id="opacity-value" class="text-xs font-bold">15%</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between bg-slate-50 p-4 rounded-xl">
                            <span class="text-xs font-bold text-slate-600 uppercase">üé® Color</span>
                            <input type="color" id="color-picker" value="#1e40af" class="w-14 h-10 rounded-lg cursor-pointer">
                        </div>
                        <button type="submit" id="submit-btn" class="w-full bg-gradient-to-r from-blue-900 to-blue-700 text-white py-5 rounded-2xl font-black text-lg shadow-xl uppercase">üéì Emitir Credencial</button>
                    </form>
                </div>

                <div id="admin-content-alumnos" class="hidden">
                    <h2 class="text-2xl font-black mb-4">Gesti√≥n de Alumnos</h2>
                    <input type="text" id="search-alumno" placeholder="üîç Buscar..." class="w-full p-3 bg-slate-50 rounded-xl font-bold mb-4">
                    <div id="alumnos-list"></div>
                </div>

                <div id="admin-content-cursos" class="hidden">
                    <h2 class="text-2xl font-black mb-4">Gesti√≥n de Cursos</h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="new-course-name" placeholder="Nuevo curso" class="flex-1 p-3 bg-slate-50 rounded-xl font-bold">
                        <button onclick="addCourse()" class="bg-green-600 text-white px-6 rounded-xl font-bold">‚ûï</button>
                    </div>
                    <div id="course-list-display"></div>
                </div>
            </section>

            <section class="flex flex-col items-center sticky top-8">
                <div id="download-area">
                    <div id="preview-container" class="carnet-preview">
                        <div class="security-guilloche"></div>
                        <svg class="holographic-stripe-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 540">
                            <defs><linearGradient id="holographic-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:rgba(255,0,0,0.06);stop-opacity:1" />
                                <stop offset="50%" style="stop-color:rgba(79,220,74,0.06);stop-opacity:1" />
                                <stop offset="100%" style="stop-color:rgba(95,21,242,0.06);stop-opacity:1" />
                            </linearGradient></defs>
                            <rect width="120" height="540" fill="url(#holographic-gradient)" opacity="0.8"/>
                        </svg>
                        <div class="microprint microprint-bottom">RENAM OFICIAL ‚Ä¢ REP√öBLICA ARGENTINA ‚Ä¢</div>
                        <div class="microprint microprint-left">RENAM ‚Ä¢ ARGENTINA ‚Ä¢</div>
                        <div class="microprint microprint-top">SISTEMA NACIONAL ‚Ä¢</div>
                        <svg class="security-rosette" viewBox="0 0 60 60">
                            <circle cx="30" cy="30" r="25" fill="none" stroke="rgba(30,64,175,0.15)" stroke-width="0.5"/>
                            <circle cx="30" cy="30" r="20" fill="none" stroke="rgba(30,64,175,0.12)" stroke-width="0.5"/>
                            <circle cx="30" cy="30" r="15" fill="none" stroke="rgba(30,64,175,0.1)" stroke-width="0.5"/>
                        </svg>
                        <div class="header-bar">
                            <span id="institucion-preview" class="inst-title">INSTITUCI√ìN</span>
                            <div class="renam-header-logo"><div class="renam-text-logo">RENAM<br><span style="font-size:9px">ARG</span></div></div>
                            <span class="id-label">PROFESSIONAL ID</span>
                        </div>
                        <div class="footer-bar">
                            <span class="footer-text">SISTEMA NACIONAL DE ACREDITACI√ìN</span>
                            <span class="footer-text">ARGENTINA</span>
                        </div>
                        <img id="photo-preview" src="https://placehold.co/280x340/e2e8f0/94a3b8?text=FOTO" alt="Foto">
                        <img id="watermark-asari" src="" alt="">
                        <div id="avales-container"></div>
                        <div id="cursos-section"><div class="curso-item-clean">SELECCIONAR CURSOS</div></div>
                        <div id="nombre-preview">NOMBRE DEL ALUMNO</div>
                        <div id="dni-container">DNI: -</div>
                        <div id="matricula-container">MATR√çCULA: -</div>
                        <div id="vence-display-preview">EMISI√ìN: -</div>
                        <div class="qr-container">
                            <div class="qr-label">VERIFICAR ONLINE</div>
                            <div class="qr-box"><canvas id="qr-code-preview"></canvas></div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex gap-4">
                    <button onclick="downloadImage('png')" class="bg-slate-800 text-white px-10 py-3 rounded-2xl font-black shadow-lg hover:scale-105 transition">üñºÔ∏è PNG</button>
                    <button onclick="downloadImage('jpeg')" class="bg-gradient-to-r from-blue-600 to-blue-800 text-white px-10 py-3 rounded-2xl font-black shadow-lg hover:scale-105 transition border-2 border-yellow-600">üìÑ JPG</button>
                </div>
            </section>
        </div>
    </div>

    <script>
        const CONFIG = {
            supabaseUrl: 'https://fuxnsebrhxxbalqfmtzs.supabase.co',
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1eG5zZWJyaHh4YmFscWZtdHpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc0Nzc2NzAsImV4cCI6MjA1MzA1MzY3MH0.fH3SZw8Y2V0ZOTr-_bsv5LXy0gxj2VPnBzLqo5M2n6E'
        };
        const sb = supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);
        let currentSession = null;
        let wizardData = { superAdmin: {}, institucion: {}, codigo: `INST-${Math.floor(1000 + Math.random() * 9000)}-2026` };

        const logosManager = {
            slots: [null, null, null, null, null],
            init() { this.renderGrid(); },
            renderGrid() {
                const grid = document.getElementById('logos-grid');
                if (!grid) return;
                grid.innerHTML = '';
                this.slots.forEach((slot, i) => {
                    const div = document.createElement('div');
                    div.className = `logo-slot ${slot ? 'has-logo' : ''}`;
                    if (slot) {
                        const img = document.createElement('img');
                        img.src = slot.dataUrl;
                        img.className = 'logo-slot-preview';
                        div.appendChild(img);
                        const removeBtn = document.createElement('div');
                        removeBtn.className = 'logo-remove-btn';
                        removeBtn.textContent = '√ó';
                        removeBtn.onclick = () => this.removeLogo(i);
                        div.appendChild(removeBtn);
                    } else {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = 'image/*';
                        input.className = 'hidden';
                        input.id = `logo-input-${i}`;
                        input.onchange = (e) => this.handleUpload(i, e.target.files[0]);
                        const label = document.createElement('label');
                        label.htmlFor = `logo-input-${i}`;
                        label.textContent = '+';
                        label.className = 'text-3xl text-gray-400 cursor-pointer hover:text-blue-600';
                        div.appendChild(input);
                        div.appendChild(label);
                    }
                    grid.appendChild(div);
                });
                this.updatePreview();
            },
            handleUpload(index, file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.slots[index] = { file: file, dataUrl: e.target.result };
                    this.renderGrid();
                };
                reader.readAsDataURL(file);
            },
            removeLogo(index) {
                this.slots[index] = null;
                this.renderGrid();
            },
            updatePreview() {
                const container = document.getElementById('avales-container');
                if (!container) return;
                container.innerHTML = '';
                this.slots.forEach(slot => {
                    if (slot) {
                        const img = document.createElement('img');
                        img.src = slot.dataUrl;
                        img.className = 'aval-logo';
                        container.appendChild(img);
                    }
                });
            }
        };

        function showNotification(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `notification ${type}`;
            div.textContent = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
        function showLoading(text = 'Cargando...') {
            const div = document.createElement('div');
            div.className = 'loading-overlay';
            div.innerHTML = `<div class="spinner"></div><p class="text-white font-bold text-xl">${text}</p>`;
            document.body.appendChild(div);
        }
        function hideLoading() { document.querySelector('.loading-overlay')?.remove(); }
        function sanitize(str) { return str.trim().replace(/[<>"']/g, ''); }
        function generatePassword() {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
            let pwd = '';
            for(let i = 0; i < 14; i++) pwd += chars[Math.floor(Math.random() * chars.length)];
            return pwd;
        }
        function generateUsername(nombre) {
            const parts = nombre.toLowerCase().split(' ');
            return `${parts[0]}.${parts[parts.length-1]}${Math.floor(100+Math.random()*900)}`.replace(/[^a-z0-9.]/g, '');
        }
        async function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > 800) { h = Math.round(h * 800 / w); w = 800; }
                        canvas.width = w;
                        canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        canvas.toBlob(resolve, 'image/jpeg', 0.85);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        async function uploadPhoto(dni, file) {
            const compressed = await compressImage(file);
            const fileName = `foto_${dni}_${crypto.randomUUID()}.jpg`;
            await sb.storage.from('fotos_carnet').upload(fileName, compressed);
            const { data } = sb.storage.from('fotos_carnet').getPublicUrl(fileName);
            return data.publicUrl;
        }

        function wizardNext(step) {
            if (step === 2) {
                const n = document.getElementById('wizard-super-nombre').value.trim();
                const e = document.getElementById('wizard-super-email').value.trim();
                const u = document.getElementById('wizard-super-username').value.trim();
                const p = document.getElementById('wizard-super-password').value;
                if (!n || !e || !u || !p || p.length < 8) return showNotification('Completa todos los campos', 'error');
                wizardData.superAdmin = { nombre: n, email: e, username: u, password: p };
                document.getElementById('wizard-inst-codigo-preview').textContent = wizardData.codigo;
            }
            if (step === 3) {
                const n = document.getElementById('wizard-inst-nombre').value.trim();
                const e = document.getElementById('wizard-inst-email').value.trim();
                if (!n || !e) return showNotification('Completa los campos', 'error');
                wizardData.institucion = {
                    nombre: n, email: e,
                    limiteAlumnos: document.getElementById('wizard-inst-limite-alumnos').value,
                    limiteUsuarios: document.getElementById('wizard-inst-limite-usuarios').value
                };
                document.getElementById('wizard-confirm-super').textContent = `${wizardData.superAdmin.nombre} (${wizardData.superAdmin.username})`;
                document.getElementById('wizard-confirm-inst').textContent = `${wizardData.institucion.nombre} - ${wizardData.codigo}`;
            }
            document.getElementById(`wizard-step-${step-1}`).classList.add('hidden');
            document.getElementById(`wizard-step-${step}`).classList.remove('hidden');
            document.getElementById(`step-dot-${step-1}`).classList.remove('active');
            document.getElementById(`step-dot-${step}`).classList.add('active');
        }
        function wizardPrev(step) {
            document.getElementById(`wizard-step-${step+1}`).classList.add('hidden');
            document.getElementById(`wizard-step-${step}`).classList.remove('hidden');
            document.getElementById(`step-dot-${step+1}`).classList.remove('active');
            document.getElementById(`step-dot-${step}`).classList.add('active');
        }

        async function completeSetup() {
            showLoading('Configurando...');
            try {
                const { data: inst, error: ie } = await sb.from('instituciones').insert([{
                    nombre: wizardData.institucion.nombre, codigo: wizardData.codigo, email: wizardData.institucion.email,
                    limite_alumnos: parseInt(wizardData.institucion.limiteAlumnos), limite_usuarios: parseInt(wizardData.institucion.limiteUsuarios), estado: 'activo'
                }]).select().single();
                if (ie) throw new Error(ie.message);
                const { error: ue } = await sb.from('usuarios').insert([{
                    username: wizardData.superAdmin.username, password: wizardData.superAdmin.password,
                    nombre_completo: wizardData.superAdmin.nombre, email: wizardData.superAdmin.email, rol: 'super_admin', institucion_id: inst.id
                }]);
                if (ue) throw new Error(ue.message);
                await sb.from('logs_sistema').insert([{ accion: 'setup_completado', usuario: wizardData.superAdmin.username, detalles: 'Sistema configurado', institucion_id: inst.id }]);
                localStorage.setItem('renam_setup_complete', 'true');
                hideLoading();
                showNotification('¬°Setup completado!', 'success');
                setTimeout(() => {
                    document.getElementById('onboarding-screen').classList.add('hidden');
                    document.getElementById('login-screen').classList.remove('hidden');
                    loadInstituciones();
                }, 2000);
            } catch (e) {
                hideLoading();
                showNotification(e.message, 'error');
            }
        }

        async function loadInstituciones() {
            const { data } = await sb.from('instituciones').select('*').order('nombre');
            const select = document.getElementById('login-institucion');
            const selectSA = document.getElementById('sa-user-institucion');
            if (data?.length > 0) {
                const opts = data.map(i => `<option value="${i.id}">${i.nombre}</option>`).join('');
                if (select) select.innerHTML = opts;
                if (selectSA) selectSA.innerHTML = '<option value="">Seleccionar...</option>' + opts;
            }
        }

        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            showLoading('Verificando...');
            try {
                const { data: user, error } = await sb.from('usuarios')
                    .select('*, instituciones(nombre)')
                    .eq('username', sanitize(document.getElementById('login-username').value))
                    .eq('password', document.getElementById('login-password').value)
                    .eq('institucion_id', document.getElementById('login-institucion').value)
                    .single();
                if (error || !user) throw new Error('Credenciales inv√°lidas');
                currentSession = {
                    user: user.username, rol: user.rol, institucion_id: user.institucion_id,
                    institucion_nombre: user.instituciones.nombre, nombre_completo: user.nombre_completo
                };
                localStorage.setItem('renam_session', JSON.stringify(currentSession));
                await sb.from('logs_sistema').insert([{ accion: 'login', usuario: user.username, detalles: 'Inicio de sesi√≥n', institucion_id: user.institucion_id }]);
                document.getElementById('login-screen').classList.add('hidden');
                if (user.rol === 'super_admin') {
                    document.getElementById('superadmin-panel').classList.remove('hidden');
                    document.getElementById('superadmin-user-info').textContent = `${currentSession.nombre_completo || currentSession.user} | ${currentSession.institucion_nombre}`;
                    await loadDashboard();
                } else {
                    document.getElementById('admin-panel').classList.remove('hidden');
                    document.getElementById('admin-user-info').textContent = `${currentSession.institucion_nombre} | ${currentSession.user}`;
                    document.getElementById('admin-role-badge').textContent = currentSession.rol.toUpperCase();
                    document.getElementById('admin-role-badge').className = `badge badge-${currentSession.rol}`;
                    document.getElementById('institucion').value = currentSession.institucion_nombre;
                    logosManager.init();
                    await loadCourses();
                    setupFormHandlers();
                }
                hideLoading();
                showNotification('¬°Bienvenido!', 'success');
            } catch (e) {
                hideLoading();
                showNotification(e.message, 'error');
            }
        };

        function logout() {
            if (!confirm('¬øCerrar sesi√≥n?')) return;
            if (currentSession) {
                sb.from('logs_sistema').insert([{ accion: 'logout', usuario: currentSession.user, detalles: 'Cierre de sesi√≥n', institucion_id: currentSession.institucion_id }]);
            }
            localStorage.removeItem('renam_session');
            currentSession = null;
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('superadmin-panel').classList.add('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            showNotification('Sesi√≥n cerrada', 'info');
        }

        function switchSATab(tab) {
            ['dashboard', 'instituciones', 'usuarios', 'logs'].forEach(t => {
                document.getElementById('sa-content-' + t)?.classList.toggle('hidden', t !== tab);
                document.getElementById('sa-tab-' + t)?.classList.toggle('tab-active', t === tab);
            });
            if (tab === 'instituciones') loadInstitucionesTable();
            if (tab === 'usuarios') loadUsuariosTable();
            if (tab === 'logs') loadLogsTable();
        }

        function switchAdminTab(tab) {
            ['generador', 'alumnos', 'cursos'].forEach(t => {
                document.getElementById('admin-content-' + t)?.classList.toggle('hidden', t !== tab);
                document.getElementById('admin-tab-' + t)?.classList.toggle('tab-active', t === tab);
            });
            if (tab === 'alumnos') loadAlumnosList();
            if (tab === 'cursos') loadCoursesList();
        }

        async function loadDashboard() {
            const { data: inst, count: ic } = await sb.from('instituciones').select('*', { count: 'exact' });
            const { data: users, count: uc } = await sb.from('usuarios').select('*', { count: 'exact' });
            const { data: creds, count: cc } = await sb.from('historial_emisiones').select('*', { count: 'exact' });
            document.getElementById('stat-inst').textContent = ic || 0;
            document.getElementById('stat-users').textContent = uc || 0;
            document.getElementById('stat-creds').textContent = cc || 0;
            const { data: logs } = await sb.from('logs_sistema').select('*, instituciones(nombre)').order('created_at', { ascending: false }).limit(5);
            const actDiv = document.getElementById('recent-activity');
            if (logs?.length > 0) {
                actDiv.innerHTML = logs.map(l => `
                    <div class="flex justify-between p-3 bg-slate-50 rounded-lg mb-2">
                        <div><p class="text-sm font-bold">${l.accion}</p><p class="text-xs text-slate-500">${l.usuario}</p></div>
                        <span class="text-xs text-slate-400">${new Date(l.created_at).toLocaleString('es-AR')}</span>
                    </div>
                `).join('');
            } else {
                actDiv.innerHTML = '<p class="text-sm text-slate-400 text-center py-4">Sin actividad</p>';
            }
        }

        async function loadInstitucionesTable() {
            showLoading();
            const { data } = await sb.from('instituciones').select('*').order('created_at', { ascending: false });
            const table = document.getElementById('instituciones-table');
            if (data?.length > 0) {
                table.innerHTML = `<table class="data-table"><thead><tr><th>Nombre</th><th>C√≥digo</th><th>Email</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>${data.map(i => `<tr><td class="font-bold">${i.nombre}</td><td><code class="text-xs bg-slate-100 px-2 py-1 rounded">${i.codigo}</code></td><td class="text-xs">${i.email || 'N/A'}</td><td><span class="badge badge-${i.estado}">${i.estado.toUpperCase()}</span></td><td><button onclick="suspenderInst(${i.id}, '${i.estado}')" class="action-btn btn-suspend">${i.estado === 'activo' ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}</button></td></tr>`).join('')}</tbody></table>`;
            } else {
                table.innerHTML = '<p class="text-center text-gray-400 p-8">Sin instituciones</p>';
            }
            hideLoading();
        }

        async function crearInstitucion() {
            const nombre = sanitize(document.getElementById('sa-inst-nombre').value);
            const email = sanitize(document.getElementById('sa-inst-email').value);
            if (!nombre || !email) return showNotification('Completa los campos', 'error');
            showLoading();
            try {
                const codigo = `INST-${Math.floor(1000 + Math.random() * 9000)}-2026`;
                await sb.from('instituciones').insert([{
                    nombre, codigo, email,
                    limite_alumnos: parseInt(document.getElementById('sa-inst-limite-alumnos').value),
                    limite_usuarios: parseInt(document.getElementById('sa-inst-limite-usuarios').value), estado: 'activo'
                }]);
                await sb.from('logs_sistema').insert([{ accion: 'crear_institucion', usuario: currentSession.user, detalles: `${nombre} (${codigo})`, institucion_id: currentSession.institucion_id }]);
                showNotification('‚úÖ Instituci√≥n creada', 'success');
                document.getElementById('sa-inst-nombre').value = '';
                document.getElementById('sa-inst-email').value = '';
                await loadInstitucionesTable();
                await loadInstituciones();
            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function suspenderInst(id, estado) {
            const nuevo = estado === 'activo' ? 'suspendido' : 'activo';
            if (!confirm(`¬ø${nuevo === 'suspendido' ? 'Suspender' : 'Reactivar'}?`)) return;
            try {
                await sb.from('instituciones').update({ estado: nuevo }).eq('id', id);
                await sb.from('logs_sistema').insert([{ accion: nuevo === 'suspendido' ? 'suspender_inst' : 'reactivar_inst', usuario: currentSession.user, detalles: `ID: ${id}`, institucion_id: currentSession.institucion_id }]);
                showNotification(`‚úÖ ${nuevo === 'suspendido' ? 'Suspendida' : 'Reactivada'}`, 'success');
                await loadInstitucionesTable();
            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
            }
        }

        document.getElementById('sa-user-nombre')?.addEventListener('input', (e) => {
            document.getElementById('sa-user-username').value = generateUsername(e.target.value);
        });

        async function crearUsuario() {
            const instId = document.getElementById('sa-user-institucion').value;
            const rol = document.getElementById('sa-user-rol').value;
            const nombre = sanitize(document.getElementById('sa-user-nombre').value);
            const email = sanitize(document.getElementById('sa-user-email').value);
            let username = document.getElementById('sa-user-username').value || generateUsername(nombre);
            let password = document.getElementById('sa-user-password').value || generatePassword();
            if (!instId || !nombre || !email) return showNotification('Completa los campos', 'error');
            showLoading();
            try {
                await sb.from('usuarios').insert([{ username, password, nombre_completo: nombre, email, rol, institucion_id: instId }]);
                await sb.from('logs_sistema').insert([{ accion: 'crear_usuario', usuario: currentSession.user, detalles: `${username} (${rol})`, institucion_id: currentSession.institucion_id }]);
                document.getElementById('gen-username').textContent = username;
                document.getElementById('gen-password').textContent = password;
                document.getElementById('password-display-area').classList.remove('hidden');
                document.getElementById('copy-btn').classList.remove('hidden');
                showNotification('‚úÖ Usuario creado', 'success');
                await loadUsuariosTable();
            } catch (e) {
                showNotification(e.message.includes('duplicate') ? 'Usuario duplicado' : 'Error: ' + e.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function copiarCreds() {
            const u = document.getElementById('gen-username').textContent;
            const p = document.getElementById('gen-password').textContent;
            navigator.clipboard.writeText(`Usuario: ${u}\nContrase√±a: ${p}`);
            showNotification('‚úÖ Copiado', 'success');
        }

        async function loadUsuariosTable() {
            showLoading();
            const { data } = await sb.from('usuarios').select('*, instituciones(nombre)').order('created_at', { ascending: false });
            const table = document.getElementById('usuarios-table');
            if (data?.length > 0) {
                table.innerHTML = `<table class="data-table"><thead><tr><th>Usuario</th><th>Nombre</th><th>Email</th><th>Rol</th><th>Instituci√≥n</th><th>Acciones</th></tr></thead><tbody>${data.map(u => `<tr><td class="font-mono font-bold">${u.username}</td><td>${u.nombre_completo || 'N/A'}</td><td class="text-xs">${u.email || 'N/A'}</td><td><span class="badge badge-${u.rol}">${u.rol.replace('_', ' ').toUpperCase()}</span></td><td class="text-xs">${u.instituciones?.nombre || 'N/A'}</td><td><button onclick="resetPwd(${u.id}, '${u.username}')" class="action-btn btn-edit">üîë</button><button onclick="delUser(${u.id}, '${u.username}')" class="action-btn btn-delete">üóëÔ∏è</button></td></tr>`).join('')}</tbody></table>`;
            } else {
                table.innerHTML = '<p class="text-center text-gray-400 p-8">Sin usuarios</p>';
            }
            hideLoading();
        }

        async function resetPwd(id, username) {
            const newPwd = generatePassword();
            if (!confirm(`¬øResetear contrase√±a de ${username}?`)) return;
            try {
                await sb.from('usuarios').update({ password: newPwd }).eq('id', id);
                await sb.from('logs_sistema').insert([{ accion: 'reset_password', usuario: currentSession.user, detalles: `Para: ${username}`, institucion_id: currentSession.institucion_id }]);
                alert(`Nueva contrase√±a para ${username}:\n\n${newPwd}\n\nGu√°rdala, no podr√°s verla nuevamente.`);
                showNotification('‚úÖ Contrase√±a actualizada', 'success');
            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
            }
        }

        async function delUser(id, username) {
            if (username === currentSession.user) return showNotification('No puedes eliminar tu usuario', 'error');
            if (!confirm(`¬øEliminar ${username}?`)) return;
            try {
                await sb.from('usuarios').delete().eq('id', id);
                await sb.from('logs_sistema').insert([{ accion: 'eliminar_usuario', usuario: currentSession.user, detalles: username, institucion_id: currentSession.institucion_id }]);
                showNotification('‚úÖ Usuario eliminado', 'success');
                await loadUsuariosTable();
            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
            }
        }

        async function loadLogsTable() {
            showLoading();
            const { data } = await sb.from('logs_sistema').select('*, instituciones(nombre)').order('created_at', { ascending: false }).limit(100);
            const table = document.getElementById('logs-table');
            if (data?.length > 0) {
                table.innerHTML = `<table class="data-table"><thead><tr><th>Fecha/Hora</th><th>Usuario</th><th>Acci√≥n</th><th>Detalles</th><th>Instituci√≥n</th></tr></thead><tbody>${data.map(l => `<tr><td class="text-xs">${new Date(l.created_at).toLocaleString('es-AR')}</td><td class="font-bold">${l.usuario}</td><td><span class="badge badge-admin">${l.accion}</span></td><td class="text-xs">${l.detalles || '-'}</td><td class="text-xs">${l.instituciones?.nombre || 'Sistema'}</td></tr>`).join('')}</tbody></table>`;
            } else {
                table.innerHTML = '<p class="text-center text-gray-400 p-8">Sin logs</p>';
            }
            hideLoading();
        }

        async function loadCourses() {
            const { data } = await sb.from('cursos').select('*').eq('institucion_id', currentSession.institucion_id).order('nombre_curso');
            const select = document.getElementById('curso-select');
            if (data?.length > 0) {
                select.innerHTML = data.map(c => `<option value="${c.id}">${c.nombre_curso.toUpperCase()}</option>`).join('');
            } else {
                select.innerHTML = '<option>No hay cursos</option>';
            }
        }

        async function loadCoursesList() {
            const { data } = await sb.from('cursos').select('*').eq('institucion_id', currentSession.institucion_id).order('nombre_curso');
            const display = document.getElementById('course-list-display');
            if (data?.length > 0) {
                display.innerHTML = data.map(c => `<div class="flex justify-between p-3 border-b hover:bg-green-50 rounded mb-2"><span class="font-bold">${c.nombre_curso}</span><div><button onclick="editCourse(${c.id}, '${c.nombre_curso.replace(/'/g, "\\'")}' )" class="action-btn btn-edit">‚úèÔ∏è</button><button onclick="deleteCourse(${c.id})" class="action-btn btn-delete">üóëÔ∏è</button></div></div>`).join('');
            }
        }

        async function addCourse() {
            if (currentSession.rol === 'visor') return showNotification('Sin permisos', 'error');
            const name = sanitize(document.getElementById('new-course-name').value);
            if (!name) return showNotification('Ingresa un nombre', 'error');
            try {
                await sb.from('cursos').insert([{ nombre_curso: name, institucion_id: currentSession.institucion_id }]);
                showNotification('‚úì Curso a√±adido', 'success');
                document.getElementById('new-course-name').value = '';
                loadCourses();
                loadCoursesList();
            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
            }
        }

        async function quickAddCourse() {
            if (currentSession.rol === 'visor') return showNotification('Sin permisos', 'error');
            const name = sanitize(document.getElementById('quick-course-name').value);
            if (!name) return showNotification('Ingresa un nombre', 'error');
            try {
                const { data } = await sb.from('cursos').insert([{ nombre_curso: name, institucion_id: currentSession.institucion_id }]).select();
                showNotification('‚úì Curso creado', 'success');
                document.getElementById('quick-course-name').value = '';
                await loadCourses();
                const select = document.getElementById('curso-select');
                const newOpt = Array.from(select.options).find(opt => opt.value == data[0].id);
                if (newOpt) {
                    newOpt.selected = true;
                    select.dispatchEvent(new Event('change'));
                }
            } catch (e) {
                showNotification('Error: ' + e.message, 'error');
            }
        }

        function editCourse(id, name) { showNotification('Funci√≥n disponible pr√≥ximamente', 'info'); }
        function deleteCourse(id) { showNotification('Funci√≥n disponible pr√≥ximamente', 'info'); }
        function loadAlumnosList() { showNotification('Funci√≥n disponible pr√≥ximamente', 'info'); }

        function setupFormHandlers() {
            document.getElementById('photo-upload').onchange = (e) => {
                if (e.target.files[0]) {
                    const r = new FileReader();
                    r.onload = (ev) => document.getElementById('photo-preview').src = ev.target.result;
                    r.readAsDataURL(e.target.files[0]);
                }
            };

            document.getElementById('watermark-upload').onchange = (e) => {
                if (e.target.files[0]) {
                    const r = new FileReader();
                    r.onload = (ev) => document.getElementById('watermark-asari').src = ev.target.result;
                    r.readAsDataURL(e.target.files[0]);
                }
            };

            document.getElementById('watermark-opacity').oninput = (e) => {
                const value = e.target.value;
                document.getElementById('opacity-value').textContent = `${value}%`;
                document.getElementById('watermark-asari').style.opacity = value / 100;
            };

            document.getElementById('color-picker').oninput = (e) => {
                document.documentElement.style.setProperty('--primary-color', e.target.value);
                document.documentElement.style.setProperty('--text-blue', e.target.value);
            };

            document.getElementById('curso-select').onchange = () => {
                const count = document.getElementById('curso-select').selectedOptions.length;
                document.getElementById('selected-count').textContent = `${count} curso(s)`;
                updatePreview();
            };

            document.getElementById('curso-search').oninput = (e) => {
                const search = e.target.value.toLowerCase();
                const options = document.getElementById('curso-select').options;
                for (let opt of options) {
                    opt.style.display = opt.text.toLowerCase().includes(search) ? 'block' : 'none';
                }
            };

            const form = document.getElementById('carnet-form');
            form.oninput = updatePreview;

            form.onsubmit = async (e) => {
                e.preventDefault();
                if (currentSession.rol === 'visor') return showNotification('Sin permisos', 'error');
                const btn = document.getElementById('submit-btn');
                btn.disabled = true;
                btn.innerHTML = '<span class="loader"></span> Procesando...';
                try {
                    const dni = document.getElementById('dni').value.replace(/\D/g, '');
                    const nombre = sanitize(document.getElementById('nombre').value).toUpperCase();
                    const selectedCursos = Array.from(document.getElementById('curso-select').selectedOptions);
                    if (!nombre) throw new Error('Ingresa el nombre');
                    if (selectedCursos.length === 0) throw new Error('Selecciona al menos un curso');
                    const photoFile = document.getElementById('photo-upload').files[0];
                    if (!photoFile) throw new Error('Sube una foto');

                    const publicUrl = await uploadPhoto(dni, photoFile);
                    let { data: alumno } = await sb.from('alumnos').select('matricula_arg').eq('dni', dni).eq('institucion_id', currentSession.institucion_id).single();
                    let matricula = alumno?.matricula_arg;
                    if (!matricula) {
                        let isUnique = false;
                        while (!isUnique) {
                            matricula = `ARG-${Math.floor(10000000 + Math.random() * 90000000)}`;
                            const { data: exists } = await sb.from('alumnos').select('matricula_arg').eq('matricula_arg', matricula).single();
                            if (!exists) isUnique = true;
                        }
                    }

                    await sb.from('alumnos').upsert({ dni, nombre_completo: nombre, matricula_arg: matricula, foto_url: publicUrl, institucion_id: currentSession.institucion_id });

                    const vence = new Date();
                    vence.setFullYear(vence.getFullYear() + 1);
                    for (const curso of selectedCursos) {
                        await sb.from('certificaciones').upsert({ alumno_dni: dni, curso_id: parseInt(curso.value), fecha_vencimiento: vence.toISOString().split('T')[0], institucion_id: currentSession.institucion_id });
                    }

                    await sb.from('historial_emisiones').insert({ alumno_dni: dni, usuario_emisor: currentSession.user, institucion_id: currentSession.institucion_id });

                    document.getElementById('matricula-container').textContent = `MATR√çCULA: ${matricula}`;
                    document.getElementById('vence-display-preview').textContent = `EMISI√ìN: ${new Date().toLocaleDateString('es-AR')}`;

                    new QRious({ element: document.getElementById('qr-code-preview'), value: `https://renam.com/verificar?m=${matricula}`, size: 100, level: 'H' });

                    showNotification('‚úì ¬°Credencial emitida!', 'success');
                } catch (err) {
                    showNotification(err.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = 'üéì Emitir Credencial';
                }
            };
        }

        function updatePreview() {
            const dni = document.getElementById('dni')?.value;
            const nombre = document.getElementById('nombre')?.value;
            const inst = document.getElementById('institucion')?.value;
            const selectedOptions = Array.from(document.getElementById('curso-select')?.selectedOptions || []);
            if (dni) document.getElementById('dni-container').textContent = `DNI: ${dni}`;
            if (nombre) document.getElementById('nombre-preview').textContent = nombre.toUpperCase();
            if (inst) document.getElementById('institucion-preview').textContent = inst.toUpperCase();
            const cursosSection = document.getElementById('cursos-section');
            if (cursosSection) {
                if (selectedOptions.length > 0) {
                    cursosSection.innerHTML = selectedOptions.map(opt => `<div class="curso-item-clean">${opt.text}</div>`).join('');
                } else {
                    cursosSection.innerHTML = '<div class="curso-item-clean">SELECCIONAR CURSOS</div>';
                }
            }
        }

        window.downloadImage = function(fmt) {
            html2canvas(document.getElementById('preview-container'), { scale: 3, useCORS: true, allowTaint: true, backgroundColor: '#ffffff' }).then(canvas => {
                const a = document.createElement('a');
                const dniVal = document.getElementById('dni').value || 'RENAM';
                a.download = `RENAM_${dniVal}_${new Date().toISOString().split('T')[0]}.${fmt === 'jpeg' ? 'jpg' : 'png'}`;
                a.href = canvas.toDataURL(`image/${fmt}`, fmt === 'jpeg' ? 0.92 : 1.0);
                a.click();
                showNotification('‚úì Descargado', 'success');
            }).catch(err => {
                showNotification('Error al descargar', 'error');
                console.error(err);
            });
        }

        async function checkSetup() {
            const complete = localStorage.getItem('renam_setup_complete');
            if (complete) return true;
            const { data, error } = await sb.from('usuarios').select('*').limit(1);
            if (error) {
                alert('‚ö†Ô∏è ERROR: Las tablas no existen.\n\nEjecuta el script SQL en Supabase antes de continuar.');
                return false;
            }
            if (!data || data.length === 0) return false;
            localStorage.setItem('renam_setup_complete', 'true');
            return true;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            showLoading('Inicializando...');
            try {
                const setupOk = await checkSetup();
                if (!setupOk) {
                    hideLoading();
                    document.getElementById('onboarding-screen').classList.remove('hidden');
                    return;
                }
                await loadInstituciones();
                const saved = localStorage.getItem('renam_session');
                if (saved) {
                    try {
                        currentSession = JSON.parse(saved);
                        if (currentSession.rol === 'super_admin') {
                            document.getElementById('superadmin-panel').classList.remove('hidden');
                            document.getElementById('superadmin-user-info').textContent = currentSession.nombre_completo || currentSession.user;
                            await loadDashboard();
                        } else {
                            document.getElementById('admin-panel').classList.remove('hidden');
                            document.getElementById('admin-user-info').textContent = `${currentSession.institucion_nombre} | ${currentSession.user}`;
                            document.getElementById('admin-role-badge').textContent = currentSession.rol.toUpperCase();
                            document.getElementById('admin-role-badge').className = `badge badge-${currentSession.rol}`;
                            document.getElementById('institucion').value = currentSession.institucion_nombre;
                            logosManager.init();
                            await loadCourses();
                            setupFormHandlers();
                        }
                        hideLoading();
                        return;
                    } catch (e) {
                        localStorage.removeItem('renam_session');
                    }
                }
                hideLoading();
                document.getElementById('login-screen').classList.remove('hidden');
            } catch (e) {
                hideLoading();
                console.error(e);
                showNotification('Error al inicializar', 'error');
            }
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RENAM v4.0 Enterprise - Sistema Completo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary-color: #1e40af; --text-blue: #1d4ed8; --dark-blue: #172554; }
        body { font-family: 'Roboto', sans-serif; background: #f0f2f5; }
        
        /* LOADING & MODAL */
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 20px; }
        .loading-overlay .spinner { width: 60px; height: 60px; border: 6px solid #f3f3f3; border-top: 6px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9998; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.2s; }
        .modal-content { background: white; border-radius: 24px; padding: 32px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* TABLES */
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th { background: #1e40af; color: white; padding: 12px; text-align: left; font-weight: 700; text-transform: uppercase; font-size: 11px; }
        .data-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .data-table tr:hover { background: #f8fafc; }
        
        /* BADGES */
        .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 10px; font-weight: 900; text-transform: uppercase; }
        .badge-super-admin { background: #7c3aed; color: white; }
        .badge-admin { background: #1e40af; color: white; }
        .badge-editor { background: #059669; color: white; }
        .badge-visor { background: #64748b; color: white; }
        .badge-activo { background: #10b981; color: white; }
        .badge-suspendido { background: #ef4444; color: white; }
        
        /* STATS */
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 24px; color: white; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); }
        .stat-card .number { font-size: 48px; font-weight: 900; line-height: 1; }
        .stat-card .label { font-size: 14px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; margin-top: 8px; }
        
        /* CREDENCIAL */
        #download-area { width: 856px; padding: 20px; background: #e2e8f0; border-radius: 20px; margin: 0 auto; }
        .carnet-preview { width: 856px; height: 540px; position: relative; overflow: hidden; background: #ffffff; font-family: 'Roboto', sans-serif; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .security-guilloche { position: absolute; inset: 0; z-index: 2; pointer-events: none; background: repeating-linear-gradient(45deg, transparent 0px, transparent 6px, rgba(30, 64, 175, 0.04) 6px, rgba(30, 64, 175, 0.04) 7px), repeating-linear-gradient(-45deg, transparent 0px, transparent 6px, rgba(30, 64, 175, 0.04) 6px, rgba(30, 64, 175, 0.04) 7px); }
        .holographic-stripe-svg { position: absolute; top: 0; right: -30px; bottom: 0; width: 120px; z-index: 5; pointer-events: none; transform: skewX(-15deg); }
        .microprint { position: absolute; font-size: 4px; font-weight: 700; color: rgba(30, 64, 175, 0.15); letter-spacing: 0.5px; line-height: 5px; transform: scaleY(0.8); z-index: 3; overflow: hidden; white-space: nowrap; }
        .microprint-bottom { bottom: 52px; left: 360px; right: 40px; }
        .microprint-left { bottom: 200px; left: 40px; writing-mode: vertical-lr; transform: rotate(180deg) scaleX(0.8); }
        .microprint-top { top: 90px; left: 360px; right: 40px; }
        .security-rosette { position: absolute; bottom: 65px; right: 55px; width: 55px; height: 55px; opacity: 0.18; z-index: 3; }
        .header-bar { position: absolute; top: 0; left: 0; width: 100%; height: 85px; background: var(--primary-color); display: flex; align-items: center; justify-content: space-between; padding: 0 50px; z-index: 50; color: white; }
        .inst-title { font-size: 28px; font-weight: 900; text-transform: uppercase; letter-spacing: -0.5px; }
        .id-label { font-size: 12px; font-weight: 900; opacity: 0.85; text-transform: uppercase; letter-spacing: 2px; }
        .renam-header-logo { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); height: 70px; width: 70px; background: radial-gradient(circle at 30% 30%, #ffffff, #f0f0f0); border-radius: 50%; padding: 3px; border: 3px solid #fbbf24; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 12px rgba(0,0,0,0.25); }
        .renam-text-logo { font-weight: 900; color: var(--primary-color); font-size: 16px; text-align: center; line-height: 0.9; }
        .footer-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 50px; background: var(--primary-color); display: flex; align-items: center; justify-content: space-between; padding: 0 50px; z-index: 50; color: white; }
        .footer-text { font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; }
        #photo-preview { position: absolute; top: 115px; left: 50px; width: 280px; height: 340px; object-fit: cover; z-index: 10; background: linear-gradient(135deg, #f1f5f9, #e2e8f0); border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 3px; }
        #avales-container { position: absolute; top: 105px; left: 360px; right: 50px; display: flex; gap: 18px; align-items: center; height: 60px; z-index: 25; }
        .aval-logo { height: 50px; width: auto; max-width: 75px; object-fit: contain; }
        #cursos-section { position: absolute; top: 185px; left: 360px; right: 50px; z-index: 20; max-height: 180px; overflow: hidden; }
        .curso-item-clean { font-size: 16px; font-weight: 700; color: var(--text-blue); text-transform: uppercase; margin-bottom: 12px; line-height: 1.2; display: flex; align-items: flex-start; }
        .curso-item-clean::before { content: '‚Ä¢'; color: var(--text-blue); margin-right: 12px; font-size: 22px; line-height: 16px; }
        #nombre-preview { position: absolute; bottom: 160px; left: 360px; right: 50px; font-size: 36px; font-weight: 900; color: var(--dark-blue); text-transform: uppercase; z-index: 30; line-height: 1.1; }
        #dni-container { position: absolute; bottom: 130px; left: 360px; font-size: 18px; font-weight: 600; color: #475569; z-index: 30; text-transform: uppercase; }
        #matricula-container { position: absolute; bottom: 102px; left: 360px; font-size: 22px; font-weight: 900; color: #000000; z-index: 30; }
        #vence-display-preview { position: absolute; bottom: 75px; left: 360px; font-size: 13px; font-weight: 700; color: #64748b; z-index: 30; text-transform: uppercase; }
        .qr-container { position: absolute; bottom: 75px; left: 50px; z-index: 110; }
        .qr-label { font-size: 8px; font-weight: 900; color: var(--primary-color); text-align: center; letter-spacing: 0.5px; margin-bottom: 2px; }
        .qr-box { width: 110px; height: 110px; background: white; padding: 5px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid #e2e8f0; border-radius: 3px; }
        #watermark-asari { position: absolute; top: 50%; right: 70px; transform: translateY(-50%) rotate(5deg); width: 350px; height: 350px; opacity: 0.15; z-index: 1; object-fit: contain; pointer-events: none; }
        
        /* LOGOS */
        .logo-slot { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 8px; min-height: 85px; display: flex; align-items: center; justify-content: center; position: relative; background: #f8fafc; transition: all 0.2s; }
        .logo-slot:hover { border-color: #3b82f6; background: #eff6ff; transform: translateY(-2px); }
        .logo-slot.has-logo { border-style: solid; border-color: #10b981; background: #f0fdf4; }
        .logo-slot-preview { max-width: 100%; max-height: 70px; object-fit: contain; }
        .logo-remove-btn { position: absolute; top: 4px; right: 4px; background: #ef4444; color: white; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; font-weight: 900; }
        .logo-remove-btn:hover { background: #dc2626; transform: scale(1.15); }
        
        /* TABS & BUTTONS */
        .tab-btn { text-align: center; padding-bottom: 0.5rem; text-transform: uppercase; font-weight: 700; font-size: 0.875rem; color: #94a3b8; transition: all 0.2s; cursor: pointer; border: none; background: none; }
        .tab-btn:hover { color: #1e40af; }
        .tab-active { border-bottom: 4px solid var(--primary-color); color: var(--primary-color); }
        .action-btn { padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer; transition: all 0.2s; border: none; }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn-edit { background: #3b82f6; color: white; }
        .btn-delete { background: #ef4444; color: white; }
        .btn-view { background: #10b981; color: white; }
        .btn-suspend { background: #f59e0b; color: white; }
        
        /* NOTIFICATIONS */
        .notification { position: fixed; top: 20px; right: 20px; z-index: 9999; padding: 16px 24px; border-radius: 12px; font-weight: 700; box-shadow: 0 10px 25px rgba(0,0,0,0.15); animation: slideIn 0.3s; }
        .notification.success { background: #10b981; color: white; }
        .notification.error { background: #ef4444; color: white; }
        .notification.info { background: #3b82f6; color: white; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* WIZARD */
        .wizard-step { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
        .step-indicator { display: flex; justify-content: center; gap: 12px; margin-bottom: 30px; }
        .step-dot { width: 12px; height: 12px; border-radius: 50%; background: #e2e8f0; transition: all 0.3s; }
        .step-dot.active { background: #1e40af; width: 40px; border-radius: 6px; }
        .password-display { background: #1e293b; color: #10b981; padding: 20px; border-radius: 12px; font-family: 'Courier New', monospace; font-size: 24px; font-weight: 900; text-align: center; letter-spacing: 3px; margin: 20px 0; }
        .watermark-section { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #fbbf24; }
    </style>
</head>
<body class="p-4 lg:p-8 min-h-screen">

    <!-- ==================== ONBOARDING WIZARD ==================== -->
    <div id="onboarding-screen" class="min-h-screen flex items-center justify-center hidden">
        <div class="wizard-step">
            <div class="text-center mb-8">
                <div class="w-24 h-24 bg-gradient-to-br from-purple-600 to-blue-900 rounded-full flex items-center justify-center text-white mx-auto mb-4 shadow-2xl border-4 border-yellow-400">
                    <div class="text-3xl font-black">RENAM</div>
                </div>
                <h1 class="text-3xl font-black text-slate-800 mb-2">¬°Bienvenido a RENAM!</h1>
                <p class="text-sm text-slate-500 font-bold">Configuraci√≥n Inicial del Sistema</p>
            </div>
            <div class="step-indicator">
                <div class="step-dot active" id="step-dot-1"></div>
                <div class="step-dot" id="step-dot-2"></div>
                <div class="step-dot" id="step-dot-3"></div>
            </div>
            <div id="wizard-step-1">
                <h2 class="text-2xl font-black text-slate-800 mb-4">Crear Super Administrador</h2>
                <div class="space-y-4">
                    <input type="text" id="wizard-super-nombre" placeholder="Nombre Completo" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200">
                    <input type="email" id="wizard-super-email" placeholder="Email" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200">
                    <input type="text" id="wizard-super-username" placeholder="Usuario" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200">
                    <input type="password" id="wizard-super-password" placeholder="Contrase√±a (min 8 caracteres)" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200">
                </div>
                <button onclick="wizardNext(2)" class="w-full mt-6 bg-gradient-to-r from-purple-600 to-blue-900 text-white py-4 rounded-xl font-black text-lg hover:from-purple-500 hover:to-blue-800 transition shadow-xl">Continuar ‚Üí</button>
            </div>
            <div id="wizard-step-2" class="hidden">
                <h2 class="text-2xl font-black text-slate-800 mb-4">Primera Instituci√≥n</h2>
                <div class="space-y-4">
                    <input type="text" id="wizard-inst-nombre" placeholder="Nombre de la Instituci√≥n" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200">
                    <input type="email" id="wizard-inst-email" placeholder="Email de Contacto" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="wizard-inst-limite-alumnos" value="1000" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200">
                        <input type="number" id="wizard-inst-limite-usuarios" value="50" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200">
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                        <p class="text-xs font-bold text-blue-900 mb-2">C√≥digo (auto):</p>
                        <p id="wizard-inst-codigo-preview" class="text-2xl font-black text-blue-600 font-mono"></p>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="wizardPrev(1)" class="flex-1 bg-slate-200 text-slate-700 py-4 rounded-xl font-black">‚Üê Atr√°s</button>
                    <button onclick="wizardNext(3)" class="flex-1 bg-gradient-to-r from-purple-600 to-blue-900 text-white py-4 rounded-xl font-black shadow-xl">Continuar ‚Üí</button>
                </div>
            </div>
            <div id="wizard-step-3" class="hidden">
                <h2 class="text-2xl font-black text-slate-800 mb-4">üéâ ¬°Listo!</h2>
                <div class="space-y-4">
                    <div class="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
                        <p class="text-xs font-bold text-purple-900 mb-2">SUPER ADMIN</p>
                        <p id="wizard-confirm-super" class="text-sm font-bold text-purple-700"></p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                        <p class="text-xs font-bold text-blue-900 mb-2">INSTITUCI√ìN</p>
                        <p id="wizard-confirm-inst" class="text-sm font-bold text-blue-700"></p>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="wizardPrev(2)" class="flex-1 bg-slate-200 text-slate-700 py-4 rounded-xl font-black">‚Üê Atr√°s</button>
                    <button onclick="completeSetup()" class="flex-1 bg-gradient-to-r from-green-600 to-green-800 text-white py-4 rounded-xl font-black shadow-xl">üöÄ Completar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== LOGIN ==================== -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center hidden">
        <div class="bg-white p-10 rounded-3xl shadow-2xl max-w-md w-full border-t-8 border-blue-900">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-blue-900 rounded-full flex items-center justify-center text-white mx-auto mb-4 shadow-xl border-4 border-yellow-600">
                    <div class="text-2xl font-black">RENAM</div>
                </div>
                <h1 class="text-3xl font-black text-blue-900">RENAM v4.0</h1>
                <p class="text-sm text-gray-500 font-bold">Enterprise Edition</p>
            </div>
            <form id="login-form" class="space-y-6">
                <input type="text" id="login-username" placeholder="Usuario" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200" required>
                <input type="password" id="login-password" placeholder="Contrase√±a" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200" required>
                <select id="login-institucion" class="w-full p-4 bg-slate-50 rounded-xl font-bold ring-2 ring-slate-200" required>
                    <option value="">Cargando...</option>
                </select>
                <button type="submit" class="w-full bg-gradient-to-r from-blue-900 to-blue-700 text-white py-5 rounded-xl font-black text-lg shadow-xl uppercase">üîê Iniciar Sesi√≥n</button>
            </form>
        </div>
    </div>

    <!-- ==================== SUPER ADMIN PANEL ==================== -->
    <div id="superadmin-panel" class="max-w-7xl mx-auto hidden">
        <header class="bg-gradient-to-r from-purple-600 to-blue-900 p-6 rounded-3xl shadow-lg mb-8 text-white">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-xl"><div class="text-xl font-black text-purple-600">RENAM</div></div>
                    <div><h1 class="text-2xl font-black">Panel Super Admin</h1><p class="text-xs opacity-90 font-bold" id="superadmin-user-info"></p></div>
                </div>
                <button onclick="logout()" class="bg-red-600 px-6 py-2 rounded-xl font-bold hover:bg-red-700">üö™ Salir</button>
            </div>
            <nav class="flex gap-6 mt-6">
                <button onclick="switchSATab('dashboard')" id="sa-tab-dashboard" class="tab-btn tab-active text-white">üìä Dashboard</button>
                <button onclick="switchSATab('instituciones')" id="sa-tab-instituciones" class="tab-btn text-white">üè¢ Instituciones</button>
                <button onclick="switchSATab('usuarios')" id="sa-tab-usuarios" class="tab-btn text-white">üë• Usuarios</button>
                <button onclick="switchSATab('logs')" id="sa-tab-logs" class="tab-btn text-white">üìú Logs</button>
            </nav>
        </header>
        <div id="sa-content-dashboard">
            <div class="grid grid-cols-3 gap-6 mb-8">
                <div class="stat-card"><div class="number" id="stat-inst">0</div><div class="label">Instituciones</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><div class="number" id="stat-users">0</div><div class="label">Usuarios</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);"><div class="number" id="stat-creds">0</div><div class="label">Credenciales</div></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-black mb-4">üìà Actividad</h3><div id="recent-activity"></div></div>
        </div>
        <div id="sa-content-instituciones" class="hidden">
            <div class="bg-white p-8 rounded-3xl shadow-xl mb-6">
                <h2 class="text-2xl font-black mb-6">‚ûï Nueva Instituci√≥n</h2>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="sa-inst-nombre" placeholder="Nombre" class="w-full p-3 bg-slate-50 rounded-xl font-bold">
                    <input type="email" id="sa-inst-email" placeholder="Email" class="w-full p-3 bg-slate-50 rounded-xl font-bold">
                    <input type="number" id="sa-inst-limite-alumnos" value="1000" class="w-full p-3 bg-slate-50 rounded-xl font-bold">
                    <input type="number" id="sa-inst-limite-usuarios" value="50" class="w-full p-3 bg-slate-50 rounded-xl font-bold">
                </div>
                <button onclick="crearInstitucion()" class="w-full mt-4 bg-gradient-to-r from-purple-600 to-blue-900 text-white py-4 rounded-xl font-black shadow-xl">üè¢ Crear</button>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-black mb-4">Instituciones</h3><div id="instituciones-table"></div></div>
        </div>
        <div id="sa-content-usuarios" class="hidden">
            <div class="bg-white p-8 rounded-3xl shadow-xl mb-6">
                <h2 class="text-2xl font-black mb-6">üë§ Nuevo Usuario</h2>
                <div class="grid grid-cols-2 gap-4">
                    <select id="sa-user-institucion" class="w-full p-3 bg-slate-50 rounded-xl font-bold"><option value="">Instituci√≥n...</option></select>
                    <select id="sa-user-rol" class="w-full p-3 bg-slate-50 rounded-xl font-bold"><option value="admin">Admin</option><option value="editor">Editor</option><option value="visor">Visor</option></select>
                    <input type="text" id="sa-user-nombre" placeholder="Nombre" class="w-full p-3 bg-slate-50 rounded-xl font-bold">
                    <input type="email" id="sa-user-email" placeholder="Email" class="w-full p-3 bg-slate-50 rounded-xl font-bold">
                    <input type="text" id="sa-user-username" placeholder="Username (auto)" class="w-full p-3 bg-slate-100 rounded-xl font-bold" readonly>
                    <input type="text" id="sa-user-password" placeholder="Password (auto)" class="w-full p-3 bg-slate-100 rounded-xl font-bold" readonly>
                </div>
                <div id="password-display-area" class="hidden mt-4"><div class="password-display"><div class="text-xs mb-2">CREDENCIALES</div><div>Usuario:
