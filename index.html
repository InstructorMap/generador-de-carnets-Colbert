<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAS Córdoba v21.0 - Gestión de Certificaciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary-color: #1e3a8a; --accent-color: #2563eb; }
        body { font-family: 'Roboto', sans-serif; background: #f8fafc; }
        #download-area { width: 856px; padding: 20px; background: #e2e8f0; border-radius: 20px; }
        .carnet-preview { width: 856px; height: 540px; position: relative; overflow: hidden; background: white; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
        .bar-style { position: absolute; left: 0; width: 100%; height: 65px; background: linear-gradient(90deg, var(--primary-color), var(--accent-color)); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; z-index: 100; color: white; }
        #photo-preview { position: absolute; top: 65px; left: 0; width: 320px; height: 475px; object-fit: cover; z-index: 10; border-bottom-right-radius: 40px; }
        #nombre-preview { position: absolute; bottom: 140px; left: 355px; font-size: 38px; font-weight: 900; color: var(--primary-color); text-transform: uppercase; z-index: 30; }
        #dni-display-preview { position: absolute; bottom: 115px; left: 355px; font-size: 18px; font-weight: 700; color: #64748b; z-index: 30; }
        #codigo-preview { position: absolute; bottom: 85px; left: 355px; font-size: 26px; font-weight: 700; color: #0f172a; z-index: 30; }
        #vence-display-preview { position: absolute; bottom: 65px; left: 355px; font-size: 14px; color: #dc2626; font-weight: 900; z-index: 30; }
        .qr-box { position: absolute; bottom: 80px; left: 25px; width: 115px; height: 115px; background: white; padding: 5px; z-index: 110; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .tab-active { border-bottom: 4px solid var(--primary-color); color: var(--primary-color); font-weight: 900; }
    </style>
</head>
<body class="p-4 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="bg-white p-6 rounded-3xl shadow-md mb-8 flex justify-between items-center">
            <h1 class="text-2xl font-black text-slate-800 tracking-tight uppercase italic">SAS Córdoba - Gestión Cloud</h1>
            <nav class="flex gap-6">
                <button onclick="switchTab('manual')" id="tab-manual" class="text-sm uppercase font-bold tab-active">Generador</button>
                <button onclick="switchTab('admin')" id="tab-admin" class="text-sm uppercase font-bold text-slate-400">Admin Cursos/Base</button>
            </nav>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <section id="form-container" class="bg-white p-8 rounded-3xl shadow-xl">
                
                <div id="content-manual">
                    <form id="carnet-form" class="space-y-4">
                        <input type="text" id="institucion" placeholder="INSTITUCIÓN" class="w-full p-4 bg-slate-50 rounded-2xl font-black ring-1 ring-slate-200 uppercase">
                        
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="nombre" placeholder="NOMBRE COMPLETO" class="p-4 bg-slate-50 rounded-2xl font-bold uppercase">
                            <input type="text" id="dni" placeholder="DNI" class="p-4 bg-slate-50 rounded-2xl font-bold">
                        </div>

                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Seleccionar Curso / Certificación</label>
                            <select id="curso-select" class="w-full p-4 bg-blue-50 border-none rounded-2xl font-black text-blue-900 focus:ring-2 focus:ring-blue-500">
                                <option value="">Cargando cursos...</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <input type="file" id="photo-upload" class="text-xs p-3 border-2 border-dashed rounded-2xl w-full" required>
                            <input type="color" id="color-picker" value="#1e3a8a" class="w-full h-14 p-1 rounded-2xl border cursor-pointer">
                        </div>

                        <button type="submit" id="submit-btn" class="w-full bg-blue-900 text-white py-5 rounded-2xl font-black text-xl hover:bg-black transition-all shadow-xl">EMITIR Y VINCULAR CERTIFICACIÓN</button>
                    </form>
                </div>

                <div id="content-admin" class="hidden space-y-6">
                    <div>
                        <h3 class="font-black text-blue-900 uppercase mb-4">Añadir Nuevo Curso</h3>
                        <div class="flex gap-2">
                            <input type="text" id="new-course-name" placeholder="Nombre del curso" class="flex-1 p-4 bg-slate-50 rounded-2xl ring-1 ring-slate-200">
                            <button onclick="addNewCourse()" class="bg-blue-600 text-white px-6 rounded-2xl font-black hover:bg-blue-700">Añadir</button>
                        </div>
                    </div>
                    <div class="border-t pt-6">
                        <h3 class="font-black text-slate-800 uppercase mb-4">Exportación Administrativa</h3>
                        <button onclick="exportCloudData()" class="w-full bg-green-600 text-white py-4 rounded-xl font-black shadow-md hover:bg-green-700">Descargar Excel de Alumnos</button>
                    </div>
                </div>
            </section>

            <section class="flex flex-col items-center sticky top-8">
                <div id="download-area">
                    <div id="preview-container" class="carnet-preview">
                        <div class="bar-style"><span id="institucion-preview" class="font-bold text-xl uppercase italic">NOMBRE INSTITUCIÓN</span><span class="text-[10px] font-black opacity-70">VALID ID</span></div>
                        <img id="photo-preview" src="https://placehold.co/320x475/f1f5f9/94a3b8?text=FOTO" alt="Titular">
                        <div id="curso-preview" class="absolute top-[175px] left-[355px] font-black text-blue-600 text-2xl uppercase tracking-tighter leading-none w-[470px]"></div>
                        <div id="nombre-preview">Nombre del Alumno</div>
                        <div id="dni-display-preview">DNI: 00.000.000</div>
                        <div id="codigo-preview">MATRÍCULA: ARG-00000000</div>
                        <div id="vence-display-preview">VENCE: --/--/----</div>
                        <div class="qr-box"><canvas id="qr-code-preview"></canvas></div>
                    </div>
                </div>
                <div class="mt-8 flex gap-4">
                    <button onclick="download('png')" class="bg-slate-800 text-white px-10 py-4 rounded-2xl font-black shadow-lg">PNG</button>
                    <button onclick="download('jpeg')" class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-black shadow-lg">JPG</button>
                </div>
            </section>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
    <script>
        const SUPABASE_URL = 'https://fuxnsebrhxxbalqfmtzs.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_brWrs7Bn3vGFS7H2mEHkKQ_hcK1a8WV';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function switchTab(tab) {
            document.getElementById('content-manual').classList.toggle('hidden', tab !== 'manual');
            document.getElementById('content-admin').classList.toggle('hidden', tab !== 'admin');
            document.getElementById('tab-manual').className = `text-sm uppercase font-bold ${tab === 'manual' ? 'tab-active' : 'text-slate-400'}`;
            document.getElementById('tab-admin').className = `text-sm uppercase font-bold ${tab === 'admin' ? 'tab-active' : 'text-slate-400'}`;
        }

        async function fetchCursos() {
            const select = document.getElementById('curso-select');
            const { data, error } = await supabaseClient.from('cursos').select('*').order('nombre_curso');
            if(data) {
                select.innerHTML = '<option value="">-- SELECCIONAR CURSO --</option>' + 
                    data.map(c => `<option value="${c.id}">${c.nombre_curso.toUpperCase()}</option>`).join('');
            }
        }

        async function addNewCourse() {
            const name = document.getElementById('new-course-name').value;
            if(!name) return alert("Ingresa un nombre de curso.");
            const { error } = await supabaseClient.from('cursos').insert([{ nombre_curso: name }]);
            if(error) alert("Error: " + error.message);
            else { alert("Curso añadido."); document.getElementById('new-course-name').value = ''; fetchCursos(); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchCursos();
            const form = document.getElementById('carnet-form');
            
            // Preview de foto
            document.getElementById('photo-upload').onchange = (e) => {
                const r = new FileReader(); r.onload = (ev) => document.getElementById('photo-preview').src = ev.target.result;
                r.readAsDataURL(e.target.files[0]);
            };

            // Cambio de curso en preview
            document.getElementById('curso-select').onchange = (e) => {
                const text = e.target.options[e.target.selectedIndex].text;
                document.getElementById('curso-preview').textContent = text === '-- SELECCIONAR CURSO --' ? '' : text;
            };

            form.oninput = (e) => {
                const id = e.target.id; const val = e.target.value;
                if(id === 'dni') document.getElementById('dni-display-preview').textContent = `DNI: ${val}`;
                else if(document.getElementById(id+'-preview')) document.getElementById(id+'-preview').textContent = val;
            };

            form.onsubmit = async (e) => {
                e.preventDefault();
                const btn = document.getElementById('submit-btn');
                const dni = document.getElementById('dni').value;
                const cursoId = document.getElementById('curso-select').value;
                if(!cursoId) return alert("Debes seleccionar un curso.");

                btn.textContent = "CONECTANDO A SUPABASE...";
                btn.disabled = true;

                try {
                    // 1. Subir Foto
                    const fotoFile = document.getElementById('photo-upload').files[0];
                    const fileName = `foto_${dni}_${Date.now()}.jpg`;
                    await supabaseClient.storage.from('fotos_carnet').upload(fileName, fotoFile);
                    const { data: { publicUrl } } = supabaseClient.storage.from('fotos_carnet').getPublicUrl(fileName);

                    // 2. Gestionar Matrícula ARG
                    let { data: alumno } = await supabaseClient.from('alumnos').select('matricula_arg').eq('dni', dni).single();
                    let matricula = alumno ? alumno.matricula_arg : `ARG-${Math.floor(10000000 + Math.random() * 90000000)}`;

                    // 3. Upsert Alumno
                    await supabaseClient.from('alumnos').upsert({
                        dni: dni, nombre_completo: document.getElementById('nombre').value, 
                        matricula_arg: matricula, foto_url: publicUrl
                    });

                    // 4. Crear Certificación (Hoja de Vida)
                    const vence = new Date(); vence.setFullYear(vence.getFullYear() + 1);
                    const venceStr = vence.toLocaleDateString('es-AR');
                    await supabaseClient.from('certificaciones').upsert({
                        alumno_dni: dni, curso_id: cursoId, fecha_vencimiento: vence.toISOString().split('T')[0]
                    });

                    document.getElementById('codigo-preview').textContent = `MATRÍCULA: ${matricula}`;
                    document.getElementById('vence-display-preview').textContent = `VENCE: ${venceStr}`;
                    
                    new QRious({ 
                        element: document.getElementById('qr-code-preview'), 
                        value: `https://instructormap.github.io/verificador-Carnet-Oficial/?id=${matricula}`, 
                        size: 115, level: 'H' 
                    });

                    alert(`¡Certificación exitosa! Alumno: ${matricula}`);
                } catch (err) {
                    alert("Error crítico: " + err.message);
                } finally {
                    btn.textContent = "EMITIR Y VINCULAR CERTIFICACIÓN";
                    btn.disabled = false;
                }
            };
        });

        function download(f) {
            html2canvas(document.getElementById('preview-container'), { scale: 3, useCORS: true }).then(c => {
                const l = document.createElement('a'); l.download = `SAS_CREDENTIAL_${Date.now()}.${f==='jpeg'?'jpg':'png'}`;
                l.href = c.toDataURL(`image/${f}`, 1.0); l.click();
            });
        }
    </script>
</body>
</html>
