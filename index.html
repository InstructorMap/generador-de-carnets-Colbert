<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Carnets v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .carnet-preview { transition: all 0.3s ease; }
        #template-upload-label { cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col lg:flex-row items-start justify-center p-4 lg:p-10 space-y-8 lg:space-y-0 lg:space-x-8 min-h-screen">

    <!-- Columna del Formulario -->
    <div class="w-full lg:w-1/3 bg-white p-8 rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-4">Panel de Creación</h2>
        
        <div id="form-content" class="space-y-4">
            <div>
                <label for="template-upload" id="template-upload-label" class="block text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 text-center py-2 px-4 rounded-md">
                    1. Cargar Plantilla de Fondo
                </label>
                <input type="file" id="template-upload" class="hidden" accept="image/*">
            </div>

            <h3 class="text-lg font-semibold pt-4">2. Datos del Titular</h3>
            <input type="text" id="titulo" placeholder="Título Principal (ej: CARNET GRUPO COLBERT)" class="w-full p-2 border rounded">
            <input type="text" id="cargo1" placeholder="Cargo 1 (ej: INSTRUCTOR OFICIAL)" class="w-full p-2 border rounded">
            <input type="text" id="cargo2" placeholder="Cargo 2 / Especialidad" class="w-full p-2 border rounded">
            <input type="text" id="nombre" placeholder="Nombre y Apellido" class="w-full p-2 border rounded">
            <input type="text" id="dni" placeholder="DNI (sin puntos)" class="w-full p-2 border rounded">
            <input type="text" id="vence" placeholder="Fecha de Vencimiento (ej: 31/12/2026)" class="w-full p-2 border rounded">
            
            <h3 class="text-lg font-semibold pt-4">3. Logos e Imágenes</h3>
            <div>
                <label class="text-sm font-medium text-gray-700">Logo Principal (cuadrado)</label>
                <input type="file" id="logo1-upload" class="w-full text-sm" accept="image/*">
            </div>
             <div>
                <label class="text-sm font-medium text-gray-700">Foto del Titular</label>
                <input type="file" id="foto-upload" class="w-full text-sm" accept="image/*">
            </div>

            <div class="pt-6">
                 <button id="submit-btn" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition-colors">
                    Generar y Guardar Carnet
                </button>
                <p id="status-message" class="text-center text-sm mt-2"></p>
            </div>
        </div>
    </div>

    <!-- Columna del Carnet y Descarga -->
    <div class="w-full lg:w-2/3 space-y-6">
        <div id="carnet-container" class="carnet-preview relative w-[856px] h-[540px] bg-gray-300 rounded-xl shadow-lg overflow-hidden flex items-center justify-center text-gray-500">
             <div id="template-bg" class="absolute inset-0 bg-cover bg-center"></div>
             <!-- Los datos se posicionarán aquí con JS -->
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-center space-x-4">
            <button id="download-png" class="bg-blue-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-blue-700">Descargar PNG</button>
            <button id="download-jpg" class="bg-teal-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-teal-700">Descargar JPG</button>
            <button id="download-pdf" class="bg-red-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-red-700">Descargar PDF</button>
        </div>
    </div>

<script>
    // --- LÓGICA DE LA APLICACIÓN ---
    const form = {
        template: document.getElementById('template-upload'),
        titulo: document.getElementById('titulo'),
        cargo1: document.getElementById('cargo1'),
        cargo2: document.getElementById('cargo2'),
        nombre: document.getElementById('nombre'),
        dni: document.getElementById('dni'),
        vence: document.getElementById('vence'),
        logo1: document.getElementById('logo1-upload'),
        foto: document.getElementById('foto-upload'),
    };
    const carnetContainer = document.getElementById('carnet-container');
    const templateBg = document.getElementById('template-bg');
    const submitBtn = document.getElementById('submit-btn');
    const statusMessage = document.getElementById('status-message');

    let matriculaGenerada = '';

    // URL de tu función sin servidor
    const API_ENDPOINT = 'https://carnet-api-green.vercel.app/api/handler';

    // Actualizar vista previa en tiempo real
    function updatePreview() {
        // Limpia el contenedor
        carnetContainer.innerHTML = '';
        carnetContainer.appendChild(templateBg); // Re-añade el fondo

        // Crear y posicionar elementos de texto
        const createText = (text, top, left, fontSize, fontWeight, color = 'white') => {
            const el = document.createElement('div');
            el.textContent = text.toUpperCase();
            el.style.position = 'absolute';
            el.style.top = `${top}px`;
            el.style.left = `${left}px`;
            el.style.fontSize = `${fontSize}px`;
            el.style.fontWeight = fontWeight;
            el.style.color = color;
            el.style.textAlign = 'left';
            carnetContainer.appendChild(el);
        };

        createText(form.titulo.value, 60, 390, 38, '700');
        createText(form.cargo1.value, 150, 390, 38, '700');
        createText(form.cargo2.value, 240, 390, 38, '700');
        createText(form.nombre.value, 330, 390, 38, '700');
        
        if (matriculaGenerada) {
            createText(`DNI: ${form.dni.value}`, 430, 520, 30, '700');
            createText(`MATRICULA: ${matriculaGenerada}`, 470, 520, 30, '700');
        } else {
             createText(`DNI: ${form.dni.value}`, 430, 520, 30, '700');
        }

        createText(`VENCE: ${form.vence.value}`, 480, 420, 24, '700');
    }

    // Manejar carga de imágenes
    const handleImageUpload = (input, callback) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => callback(e.target.result);
            reader.readAsDataURL(input.files[0]);
        }
    };
    
    form.template.addEventListener('change', () => handleImageUpload(form.template, (src) => {
        templateBg.style.backgroundImage = `url(${src})`;
    }));

    form.logo1.addEventListener('change', () => handleImageUpload(form.logo1, (src) => {
        const img = document.createElement('img');
        img.src = src;
        img.style.position = 'absolute';
        img.style.top = '420px';
        img.style.left = '420px';
        img.style.width = '80px';
        img.style.height = '80px';
        carnetContainer.appendChild(img);
    }));
    
    form.foto.addEventListener('change', () => handleImageUpload(form.foto, (src) => {
        const photoContainer = document.createElement('div');
        photoContainer.style.position = 'absolute';
        photoContainer.style.top = '50px';
        photoContainer.style.left = '50px';
        photoContainer.style.width = '280px';
        photoContainer.style.height = '440px';
        photoContainer.style.backgroundImage = `url(${src})`;
        photoContainer.style.backgroundSize = 'cover';
        photoContainer.style.backgroundPosition = 'center';
        photoContainer.style.borderRadius = '140px / 120px'; // Simula el óvalo
        photoContainer.style.overflow = 'hidden';
        carnetContainer.appendChild(photoContainer);
    }));
    
    // Generar QR
    function generateQRCode() {
        const qrCanvas = document.createElement('canvas');
        // Apunta a la página verificadora con la matrícula
        const verifierBaseUrl = 'https://instructormap.github.io/verificador-Carnet-Oficial/';
        new QRious({
            element: qrCanvas,
            value: `${verifierBaseUrl}?id=${matriculaGenerada}`,
            size: 120,
            level: 'H'
        });
        const img = document.createElement('img');
        img.src = qrCanvas.toDataURL();
        img.style.position = 'absolute';
        img.style.top = '40px';
        img.style.right = '40px';
        carnetContainer.appendChild(img);
    }
    
    // Enviar datos al "cerebro" (función sin servidor)
    submitBtn.addEventListener('click', async () => {
        statusMessage.textContent = 'Procesando...';
        submitBtn.disabled = true;

        if (!form.dni.value || !form.nombre.value || !form.cargo2.value) {
            statusMessage.textContent = 'Error: DNI, Nombre y Especialidad son requeridos.';
            submitBtn.disabled = false;
            return;
        }

        try {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nombre: form.nombre.value,
                    dni: form.dni.value,
                    curso: form.cargo2.value,
                    // Añade otros campos que quieras guardar
                    titulo: form.titulo.value,
                    cargo1: form.cargo1.value,
                    vence: form.vence.value
                })
            });

            if (!response.ok) {
                throw new Error('El servidor devolvió un error.');
            }

            const result = await response.json();
            matriculaGenerada = result.matricula;
            statusMessage.textContent = `¡Éxito! Matrícula: ${matriculaGenerada}`;
            
            updatePreview(); // Actualiza la vista previa con la matrícula
            generateQRCode(); // Y el QR

        } catch (error) {
            console.error('Error al guardar:', error);
            statusMessage.textContent = 'Error al guardar los datos.';
        } finally {
            submitBtn.disabled = false;
        }
    });

    // Añadir listeners para actualizar la vista previa
    Object.values(form).forEach(input => {
        if (input.type !== 'file') {
            input.addEventListener('input', updatePreview);
        }
    });

    // Lógica de Descarga
    const download = (format, quality = 1.0) => {
        html2canvas(carnetContainer, { scale: 2 }).then(canvas => {
            if (format === 'pdf') {
                const pdf = new jspdf.jsPDF({ orientation: 'landscape', unit: 'px', format: [856, 540] });
                pdf.addImage(canvas.toDataURL('image/jpeg', quality), 'JPEG', 0, 0, 856, 540);
                pdf.save(`carnet-${form.dni.value}.pdf`);
            } else {
                const link = document.createElement('a');
                link.href = canvas.toDataURL(`image/${format}`, quality);
                link.download = `carnet-${form.dni.value}.${format}`;
                link.click();
            }
        });
    };
    document.getElementById('download-png').addEventListener('click', () => download('png'));
    document.getElementById('download-jpg').addEventListener('click', () => download('jpeg'));
    document.getElementById('download-pdf').addEventListener('click', () => download('pdf', 0.95));

</script>
</body>
</html>

