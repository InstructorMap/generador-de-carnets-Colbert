<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración de Carnets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Pantalla de Contraseña -->
    <div id="login-screen" class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm text-center">
        <h1 class="text-2xl font-bold mb-6">Acceso de Administrador</h1>
        <form id="login-form">
            <label for="password" class="block text-sm font-medium text-gray-700 text-left">Contraseña</label>
            <input type="password" id="password" class="mt-1 w-full p-2 border rounded" required>
            <p id="login-error" class="text-red-500 text-sm mt-2 hidden">Contraseña incorrecta.</p>
            <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold mt-4 hover:bg-indigo-700">
                Ingresar
            </button>
        </form>
    </div>

    <!-- Pantalla de Búsqueda (Oculta por defecto) -->
    <div id="search-screen" class="bg-white p-8 rounded-lg shadow-md w-full max-w-6xl hidden">
        <h1 class="text-2xl font-bold mb-6">Buscador de Titulares</h1>
        <form id="search-form" class="flex items-center space-x-2">
            <input type="text" id="search-query" placeholder="Buscar por Nombre o DNI..." class="flex-grow p-2 border rounded">
            <button type="submit" class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-700">
                Buscar
            </button>
        </form>
        <div id="search-results" class="mt-6 overflow-x-auto">
            <!-- Los resultados aparecerán aquí -->
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const API_ENDPOINT = 'https://carnet-api-green.vercel.app/api/handler';
        const PASSWORD = 'cambiame'; // <-- ¡Recuerda cambiar esta contraseña!

        // --- ELEMENTOS DEL DOM ---
        const loginScreen = document.getElementById('login-screen');
        const searchScreen = document.getElementById('search-screen');
        const loginForm = document.getElementById('login-form');
        const searchForm = document.getElementById('search-form');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');
        const searchQuery = document.getElementById('search-query');
        const searchResults = document.getElementById('search-results');

        // --- LÓGICA DE LOGIN ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (passwordInput.value === PASSWORD) {
                loginScreen.classList.add('hidden');
                searchScreen.classList.remove('hidden');
            } else {
                loginError.classList.remove('hidden');
            }
        });

        // --- LÓGICA DE BÚSQUEDA ---
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await performSearch();
        });

        async function performSearch() {
            const query = searchQuery.value.trim();
            if (!query) return;
            searchResults.innerHTML = '<p class="text-center text-gray-500">Buscando...</p>';
            try {
                const response = await fetch(`${API_ENDPOINT}?query=${encodeURIComponent(query)}`);
                const result = await response.json();
                if (response.ok && result.success) {
                    displayResults(result.data);
                } else {
                    throw new Error(result.message || 'Error en la búsqueda.');
                }
            } catch (error) {
                searchResults.innerHTML = `<p class="text-center text-red-500">Error: ${error.message}</p>`;
            }
        }

        function displayResults(data) {
            if (data.length === 0) {
                searchResults.innerHTML = '<p class="text-center text-gray-500">No se encontraron resultados.</p>';
                return;
            }
            const table = `
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="p-2 border-b">Nombre</th>
                            <th class="p-2 border-b">DNI</th>
                            <th class="p-2 border-b">Email</th>
                            <th class="p-2 border-b">Matrícula</th>
                            <th class="p-2 border-b text-center">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(item => `
                            <tr class="hover:bg-gray-50">
                                <td class="p-2 border-b">${item.nombre || ''}</td>
                                <td class="p-2 border-b">${item.dni || ''}</td>
                                <td class="p-2 border-b">${item.email || '<span class="text-red-500">No registrado</span>'}</td>
                                <td class="p-2 border-b">${item.matricula || 'N/A'}</td>
                                <td class="p-2 border-b text-center">
                                    <button 
                                        onclick="sendMagicLink('${item.dni}', this)" 
                                        class="bg-green-500 text-white text-sm py-1 px-3 rounded hover:bg-green-600 disabled:bg-gray-400"
                                        ${!item.email ? 'disabled title="Se requiere un email para enviar el enlace"' : ''}
                                    >
                                        Enviar Enlace
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            searchResults.innerHTML = table;
        }

        // --- ¡NUEVO! LÓGICA DE ENVÍO DE "MAGIC LINK" ---
        async function sendMagicLink(dni, buttonElement) {
            if (!confirm(`¿Estás seguro de que quieres enviar un enlace de acceso al alumno con DNI ${dni}?`)) {
                return;
            }
            
            buttonElement.disabled = true;
            buttonElement.textContent = 'Enviando...';

            try {
                const response = await fetch(`${API_ENDPOINT}?generateTokenForDni=${encodeURIComponent(dni)}`);
                const result = await response.json();

                if (response.ok && result.success) {
                    alert(result.message);
                } else {
                    throw new Error(result.message || 'Ocurrió un error al enviar el enlace.');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                buttonElement.disabled = false;
                buttonElement.textContent = 'Enviar Enlace';
            }
        }
    </script>
</body>
</html>

